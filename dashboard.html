<!DOCTYPE html>
<html>
<head>
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>


<!-- Then your app.js -->
<script src="./js/app.js"></script>

</head>
<body>
  <div class="navbar">
    <div class="user-info">
      <div class="avatar"></div>
      <span id="driverName">Hello, John Doe</span>
    </div>
    <div class="menu">
      <button onclick="showSection('home')">Home</button>
      <button onclick="showSection('addJourney')">Add Journey</button>
      <button onclick="showSection('history')">History</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="home" class="section active">
    <h2>Pending Journeys</h2>
    <table id="pendingTable">
      <thead>
        <tr>
          <th>Vehicle</th><th>Start Point</th><th>Start KM</th><th>Start Time</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="journeys-table-body">
        <!-- Data will be inserted here by JavaScript -->
    </tbody>
    </table>
  </div>

  <div id="addJourney" class="section">
    <h2>Start New Journey</h2>
    <form id="journeyForm">
      <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required>
      <input type="text" id="vehicleName" placeholder="Vehicle Name" required>
      <input type="text" id="startPoint" placeholder="Starting Point" required>
      <input type="number" id="startKm" placeholder="Starting KM" required>
      <input type="time" id="startTime" required>
      <input type="number" id="passengerCount" placeholder="No. of Passengers" required>
      <input type="text" id="passengerName" placeholder="One Passenger Name" required>
      <input type="tel" id="passengerPhone" placeholder="Passenger Phone (10-digits)" pattern="[0-9]{10}" required>
      <button type="submit">Start Journey</button>
      <button type="button" onclick="saveAsPending()">Save as Pending</button>
    </form>
  </div>

  <div id="history" class="section">
    <h2>Journey History</h2>
   <!-- Pending Trips Table (for Home Page) -->
<table id="pendingTripsTable">
  <thead>
    <tr>
      <th>Travel ID</th>
      <th>Date</th>
      <th>Vehicle Number</th>
      <th>Starting Point</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Completed Trips Table (for History Page) -->
<table id="completedTripsTable">
  <thead>
    <tr>
      <th>Travel ID</th>
      <th>Date</th>
      <th>Vehicle Number</th>
      <th>Starting Point</th>
      <th>Ending Point</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  </div>

  <script src="js/app.js"></script>
  
<script>
// Function to load pending journeys when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Fetch pending journeys from Google Sheets web app endpoint
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=pending-journeys")
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Pending journeys data:", data);
      
      // Get the table body element
      const tableBody = document.querySelector('#home tbody');
      
      // Clear any existing rows
      tableBody.innerHTML = '';
      
      // Check if there's any data
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">No pending journeys found</td></tr>';
        return;
      }
      
      // Add each journey as a row in the table
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        // Adjust these property names to match your actual column headers
        row.innerHTML = `
          <td>${journey['Vehicle Number'] || ''}</td>
          <td>${journey['Start Point'] || ''}</td>
          <td>${journey['Start KM'] || ''}</td>
          <td>${journey['Start Time'] || ''}</td>
          <td>
            <button class="btn btn-primary complete-btn" data-id="${journey['Travel ID'] || ''}">
              Complete
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to complete buttons
      document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const travelId = this.getAttribute('data-id');
          completeJourney(travelId);
        });
      });
    })
    .catch(error => {
      console.error("Error loading pending journeys:", error);
      document.querySelector('#home tbody').innerHTML = `
        <tr>
          <td colspan="5">Error loading data. Please try again later.</td>
        </tr>
      `;
    });
});

// Function to mark a journey as complete
function completeJourney(travelId) {
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      type: "complete-journey",
      travelId: travelId
    })
  })
  .then(response => response.text())
  .then(result => {
    console.log("Journey completion result:", result);
    alert("Journey marked as complete!");
    // Refresh the table
    location.reload();
  })
  .catch(error => {
    console.error("Error completing journey:", error);
    alert("Error marking journey as complete. Please try again.");
  });
}
</script>
</body>
</html>
