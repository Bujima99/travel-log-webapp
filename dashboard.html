<!DOCTYPE html>
<html>
<head>
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>


<!-- Then your app.js -->
<script src="./js/app.js"></script>

</head>
<body>
  <div class="navbar">
    <div class="user-info">
      <div class="avatar"></div>
      <span id="driverName"></span>
    </div>
    <div class="menu">
      <button onclick="showSection('home')">Home</button>
      <button onclick="showSection('addJourney')">Add Journey</button>
      <button onclick="showSection('history')">History</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="home" class="section active">
    <h2>Pending Journeys</h2>
    <table id="pendingTable">
      <thead>
        <tr>
          <th>Vehicle</th><th>Start Point</th><th>Start KM</th><th>Start Time</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="journeys-table-body">
        <!-- Data will be inserted here by JavaScript -->
    </tbody>
    </table>
  </div>

  <div id="addJourney" class="section">
    <h2>Start New Journey</h2>
    <form id="journeyForm">
      <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required>
      <input type="text" id="vehicleName" placeholder="Vehicle Name" required>
      <input type="text" id="startPoint" placeholder="Starting Point" required>
      <input type="number" id="startKm" placeholder="Starting KM" required>
      <input type="time" id="startTime" required>
      <input type="number" id="passengerCount" placeholder="No. of Passengers" required>
      <input type="text" id="passengerName" placeholder="One Passenger Name" required>
      <input type="tel" id="passengerPhone" placeholder="Passenger Phone (10-digits)" pattern="[0-9]{10}" required>
      <button type="button" onclick="saveAsPending()">Save as Pending</button>
    </form>
  </div>

 <div id="history" class="section">
  <h2>Journey History</h2>
  <table id="completedTripsTable">
    <thead>
      <tr>
        <th>Travel ID</th>
        <th>Date</th>
        <th>Vehicle Number</th>
        <th>Vehicle Name</th>
        <th>Start Point</th>
        <th>End Point</th>
        <th>Start KM</th>
        <th>End KM</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Passenger Count</th>
        <th>Passenger Name</th>
        <th>Passenger Phone</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

  <script src="js/app.js"></script>
  
<script>
// Function to load pending journeys when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Fetch pending journeys from Google Sheets web app endpoint
  const driverData = JSON.parse(localStorage.getItem('driverData'));
    
    if (driverData) {
        // Display driver name
        const driverNameElement = document.getElementById('driverName');
        if (driverNameElement) {
            driverNameElement.textContent = driverData.name;
        }
        
        // You can use other data as needed
        console.log('Driver ID:', driverData.id);
        
    } else {
        // If no driver data found, redirect to login
        window.location.href = 'login.html';
    }
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=pending-journeys")
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Pending journeys data:", data);
      
      // Get the table body element
      const tableBody = document.querySelector('#home tbody');
      
      // Clear any existing rows
      tableBody.innerHTML = '';
      
      // Check if there's any data
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">No pending journeys found</td></tr>';
        return;
      }
      
      // Add each journey as a row in the table
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        // Adjust these property names to match your actual column headers
        row.innerHTML = `
          <td>${journey['VehicleNumber'] || ''}</td>
          <td>${journey['StartPoint'] || ''}</td>
          <td>${journey['StartKM'] || ''}</td>
          <td>${journey['StartTime'] || ''}</td>
          <td>
            <button class="btn btn-primary complete-btn" data-id="${journey['TravelID'] || ''}">
              Complete
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to complete buttons
      document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const travelId = this.getAttribute('data-id');
          completeJourney(travelId);
        });
      });
    })
    .catch(error => {
      console.error("Error loading pending journeys:", error);
      document.querySelector('#home tbody').innerHTML = `
        <tr>
          <td colspan="5">Error loading data. Please try again later.</td>
        </tr>
      `;
    });
});

// Function to mark a journey as complete
function completeJourney(travelId) {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId= driverData.id;
   fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=complete-journey&travelId=${encodeURIComponent(travelId)}&driverId=${encodeURIComponent(driverId)}`)
  .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
  })
  .then(data => {
      if (!data.success) {
        throw new Error(data.message || "Journey not found");
      }
      
      const journey = data.data;
      console.log("Journey details:", journey);
    
    // Create a modal/form to show and edit the details
    const modalHTML = `
      <div id="completeJourneyModal" class="modal" style="display:block;">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <h2>Complete Journey</h2>
          <form id="completeJourneyForm">
            <input type="hidden" id="travelId" value="${travelId}">
            
            <div class="form-group">
              <label>Vehicle Number:</label>
              <input type="text" id="completeVehicleNumber" value="${journey.VehicleNumber || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Vehicle Name:</label>
              <input type="text" id="completeVehicleName" value="${journey.VehicleName || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Start Point:</label>
              <input type="text" id="completeStartPoint" value="${journey.StartPoint || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Start KM:</label>
              <input type="number" id="completeStartKm" value="${journey.StartKM || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Start Time:</label>
              <input type="time" id="completeStartTime" value="${(journey.StartTime).split('T')[1].split('.')[0] || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Passenger Count:</label>
              <input type="number" id="completePassengerCount" value="${journey.PassengerCount || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Passenger Name:</label>
              <input type="text" id="completePassengerName" value="${journey.PassengerName || ''}" required>
            </div>
            
            <div class="form-group">
              <label>Passenger Phone:</label>
              <input type="tel" id="completePassengerPhone" value="${journey.PassengerPhone || ''}" pattern="[0-9]{10}" required>
            </div>
            
            <!-- Additional fields for completion -->
            <div class="form-group">
              <label>End Point:</label>
              <input type="text" id="completeEndPoint" required>
            </div>
            
            <div class="form-group">
              <label>End KM:</label>
              <input type="number" id="completeEndKm" required>
            </div>
            
            <div class="form-group">
              <label>End Time:</label>
              <input type="time" id="completeEndTime" required>
            </div>
            
            <button type="button" onclick="submitCompletedJourney()">Complete Journey</button>
          </form>
        </div>
      </div>
    `;
    
    // Add the modal to the body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  })
  .catch(error => {
    console.error("Error fetching journey details:", error);
    alert("Error loading journey details. Please try again.");
  });
}

// Function to close the modal
function closeModal() {
  const modal = document.getElementById('completeJourneyModal');
  if (modal) {
    modal.remove();
  }
}

// Function to submit the completed journey
function submitCompletedJourney() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId = driverData.id;
  
  // Get all form values
  const travelId = document.getElementById('travelId').value;
  const vehicleNumber = document.getElementById('completeVehicleNumber').value;
  const vehicleName = document.getElementById('completeVehicleName').value;
  const startPoint = document.getElementById('completeStartPoint').value;
  const startKm = document.getElementById('completeStartKm').value;
  const startTime = document.getElementById('completeStartTime').value;
  const passengerCount = document.getElementById('completePassengerCount').value;
  const passengerName = document.getElementById('completePassengerName').value;
  const passengerPhone = document.getElementById('completePassengerPhone').value;
  const endPoint = document.getElementById('completeEndPoint').value;
  const endKm = document.getElementById('completeEndKm').value;
  const endTime = document.getElementById('completeEndTime').value;

  // Validate required fields
  if (!endPoint || !endKm || !endTime) {
    alert('Please fill in all completion details');
    return;
  }

  // Create completion data object
  const completionData = {
    type: 'submit-complete-journey',
    travelId: travelId,
    driverId: driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone,
    endPoint: endPoint,
    endKm: endKm,
    endTime: endTime
  };

  // Send data to Google Sheets web app
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    mode: 'no-cors',
    body: JSON.stringify(completionData)
  })
  .then(response => response.text())
  .then(result => {
    console.log("Journey completion result:", result);
    alert("Journey completed successfully!");
    closeModal();
    location.reload();
  })
  .catch(error => {
    console.error("Error completing journey:", error);
    alert("Error completing journey. Please try again.");
  });
}

// Function to save journey as pending
function saveAsPending() {
  // Get form values
   const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverName = driverData.name;
  const driverId= driverData.id;
  const driverPhone = driverData.phoneNumber;
  const vehicleNumber = document.getElementById('vehicleNumber').value;
  const vehicleName = document.getElementById('vehicleName').value;
  const startPoint = document.getElementById('startPoint').value;
  const startKm = document.getElementById('startKm').value;
  const startTime = document.getElementById('startTime').value;
  const passengerCount = document.getElementById('passengerCount').value;
  const passengerName = document.getElementById('passengerName').value;
  const passengerPhone = document.getElementById('passengerPhone').value;

  // Validate required fields
  if (!vehicleNumber || !startPoint || !startKm || !startTime) {
    alert('Please fill in all required fields');
    return;
  }

  // Create journey data object
  const journeyData = {
    type: 'add-pending-journey',
    driverName:driverName,
    driverPhone:driverPhone,
    driverId:driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone
  };

  // Send data to Google Sheets web app
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(journeyData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response =>response.text())
  .then(result => {
    console.log("Save as Pending result:", result);
    alert("Journey saved as pending successfully!");
    document.getElementById('journeyForm').reset();
    showSection('home');
    location.reload();
  })
  .catch(error => {
    console.error("Error saving pending journey:", error);
    alert("Error saving journey as pending. Please try again.");
  });
}


// Function to load completed journeys when History section is shown
function loadCompletedJourneys() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    console.error('No driver data found');
    return;
  }

  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=history-journey&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Completed journeys data:", data);
      const tableBody = document.querySelector('#completedTripsTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="15">No completed journeys found</td></tr>';
        return;
      }
      
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${journey.TravelID || ''}</td>
          <td>${journey.Date || ''}</td>
          <td>${journey.VehicleNumber || ''}</td>
          <td>${journey.VehicleName || ''}</td>
          <td>${journey.StartPoint || ''}</td>
          <td>${journey.EndPoint || ''}</td>
          <td>${journey.StartKM || ''}</td>
          <td>${journey.EndKM || ''}</td>
          <td>${formatTime(journey.StartTime)}</td>
          <td>${formatTime(journey.EndTime)}</td>
          <td>${journey.NoPassengers || ''}</td>
          <td>${journey.PassengerName || ''}</td>
          <td>${journey.PassengerPhone || ''}</td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => {
      console.error("Error loading completed journeys:", error);
      document.querySelector('#completedTripsTable tbody').innerHTML = `
        <tr>
          <td colspan="15">Error loading data. Please try again later.</td>
        </tr>
      `;
    });
}

function formatTime(timeString) {
  // Handle null/undefined/empty values
  if (!timeString) return '';
  
  // Convert to string if it isn't already
  timeString = String(timeString);
  
  // If it's already in HH:MM format
  if (timeString.includes(':')) return timeString;
  
  // If it's in ISO format (from spreadsheet)
  if (timeString.includes('T')) {
    try {
      const date = new Date(timeString);
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch (e) {
      return timeString; // Return original if date parsing fails
    }
  }
  
  return timeString;
}



  
</script>
</body>
</html>
