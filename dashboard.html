
<!DOCTYPE html>
<html>
<head>
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./js/app.js"></script>

</head>
<body>


<div class="loader-container" id="loader">
    <div class="loader"></div>
</div>

<!-- Replace  existing navbar   navigation rail -->
<div class="nav-rail">
  <div class="nav-header">
    <div class="user-info">
      <div class="avatar"></div>
      <span id="driverName"></span>
    </div>
    <button class="nav-toggle" id="navToggle">
      <span class="material-symbols-outlined">menu</span>
    </button>
  </div>
  
 <nav class="nav-menu">
  <ul>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('home')" class="nav-item active">
        <span class="material-symbols-outlined">home</span>
        <span class="nav-text">Home</span>
      </a>
    </li>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('fuel')" class="nav-item">
        <span class="material-symbols-outlined">local_gas_station</span>
        <span class="nav-text">Fuel</span>
      </a>
    </li>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('history')" class="nav-item">
        <span class="material-symbols-outlined">history</span>
        <span class="nav-text">History</span>
      </a>
    </li>
    <li>
      <a href="#" onclick="logout()" class="nav-item">
        <span class="material-symbols-outlined">logout</span>
        <span class="nav-text">Logout</span>
      </a>
    </li>
  </ul>
</nav>
</div>

<!-- Add this overlay for mobile -->
<div class="nav-overlay" id="navOverlay"></div>
<div class="main-content">

  <div id="home" class="section active">
    <h2>Pending Journeys</h2>
    <div class="table-wrapper">
    <table class="fl-table" id="pendingTable">
        <thead>
        <tr>
            <th>Vehicle</th>
            <th>Start Point</th>
            <th>Start KM</th>
            <th>Start Time</th>
            <th>Action</th>
        </tr>
        </thead>
      <tbody id="journeys-table-body">
        <!-- Data will be inserted here by JavaScript -->
    </tbody>
    </table>
  </div>

<!-- Replace the existing FAB button with this -->
<div class="fab-wrapper">
  <input type="checkbox" id="fabToggle" />
  <div class="fab">
    <span class="plus-icon">ï¼‹</span>
  </div>
  <div class="fab-actions">
    <a href="#" onclick="event.preventDefault(); showSection('addJourney')" class="fab-action">
      <span class="material-symbols-outlined">directions_car</span>
    </a>
    <a href="#" onclick="event.preventDefault(); showSection('fuel')" class="fab-action">
      <span class="material-symbols-outlined">local_gas_station</span>
    </a>
  </div>
</div>
    
  </div>
  <div id="addJourney" class="section">
    <h2>Start New Journey</h2>
    <form id="journeyForm">
      <select id="vehicleName" required onchange="updateVehicleNumber()">
        <option value="">Select Vehicle</option>
      </select>
     <input type="text" id="vehicleNumber" placeholder="Vehicle Number" readonly required>
      <input type="text" id="startPoint" placeholder="Starting Point" required>
      <input type="number" id="startKm" placeholder="Starting KM" required>
      <input type="time" id="startTime" required>
      <input type="number" id="passengerCount" placeholder="No. of Passengers" required>
      <input type="text" id="passengerName" placeholder="One Passenger Name" required>
      <input type="tel" id="passengerPhone" placeholder="Passenger Phone (10-digits)" pattern="[0-9]{10}" required>
      <button type="button" onclick="saveAsPending()">Save as Pending</button>
    </form>
  </div>


  <!-- Add the Fuel section after the History section -->
<div id="fuel" class="section">
  <h2>Fuel Entry</h2>
  <form id="fuelForm" enctype="multipart/form-data">
     <select id="fuelVehicleName" required onchange="updateVehicleNumber()">
        <option value="">Select Vehicle</option>
      </select>
     <input type="text" id="fuelVehicleNumber" placeholder="Vehicle Number" readonly required>
    <input type="date" id="fuelDate" required>
    <input type="text" id="fuelInvoiceNumber" placeholder="Invoice Number" required>
    <select id="fuelType" required>
      <option value="">Select Fuel Type</option>
      <option value="Petrol">Petrol</option>
      <option value="Diesel">Diesel</option>
      <option value="CNG">CNG</option>
      <option value="Electric">Electric</option>
    </select>
    <input type="number" id="fuelAmount" placeholder="Amount" step="0.01" required>
    <input type="number" id="fuelLiters" placeholder="Liters" step="0.01" required>
    <input type="number" id="fuelCurrentKm" placeholder="Current KM" required>
    <input type="file" id="fuelBillImage" accept="image/*" required>
    <button type="button" onclick="submitFuelEntry()">Submit Fuel Entry</button>
  </form>
</div>

 <div id="history" class="section">
  <h2>Journey History</h2>
   <div class="table-wrapper">
  <table class="fl-table" id="completedTripsTable">
    <thead>
      <tr>
        <th>Travel ID</th>
        <th>Date</th>
        <th>Vehicle Number</th>
        <th>Vehicle Name</th>
        <th>Start Point</th>
        <th>End Point</th>
        <th>Start KM</th>
        <th>End KM</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Passenger Count</th>
        <th>Passenger Name</th>
        <th>Passenger Phone</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
   </div>
  

</div>

<div id="completeJourney" class="section">
  <h2>Complete Journey</h2>
  <form id="completeJourneyForm">
    <input type="hidden" id="travelId">
    
    <div class="form-group">
      <label>Vehicle Number:</label>
      <input type="text" id="completeVehicleNumber" required>
    </div>
    
    <div class="form-group">
      <label>Vehicle Name:</label>
      <input type="text" id="completeVehicleName" required>
    </div>
    
    <div class="form-group">
      <label>Start Point:</label>
      <input type="text" id="completeStartPoint" required>
    </div>
    
    <div class="form-group">
      <label>Start KM:</label>
      <input type="number" id="completeStartKm" required>
    </div>
    
    <div class="form-group">
      <label>Start Time:</label>
      <input type="time" id="completeStartTime" required>
    </div>
    
    <div class="form-group">
      <label>Passenger Count:</label>
      <input type="number" id="completePassengerCount" required>
    </div>
    
    <div class="form-group">
      <label>Passenger Name:</label>
      <input type="text" id="completePassengerName" required>
    </div>
    
    <div class="form-group">
      <label>Passenger Phone:</label>
      <input type="tel" id="completePassengerPhone" pattern="[0-9]{10}" required>
    </div>
    
    <!-- Additional fields for completion -->
    <div class="form-group">
      <label>End Point:</label>
      <input type="text" id="completeEndPoint" required>
    </div>
    
    <div class="form-group">
      <label>End KM:</label>
      <input type="number" id="completeEndKm" required>
    </div>
    
    <div class="form-group">
      <label>End Time:</label>
      <input type="time" id="completeEndTime" required>
    </div>
    
    <button type="button" onclick="submitCompletedJourney()">Complete Journey</button>
    <button type="button" class="cancel-btn" onclick="showSection('home')">Cancel</button>
  </form>
</div>

</div>
  <script src="js/app.js"></script>
  
<script>
  // Add data labels for mobile view
function addMobileLabels() {
    if (window.innerWidth <= 767) {
        const headers = document.querySelectorAll('.fl-table thead th');
        const rows = document.querySelectorAll('.fl-table tbody tr');
        
        headers.forEach((header, index) => {
            const label = header.textContent;
            rows.forEach(row => {
                const cell = row.querySelectorAll('td')[index];
                if (cell) {
                    cell.setAttribute('data-label', label);
                }
            });
        });
    }
}

// Run on load and resize
window.addEventListener('load', addMobileLabels);
window.addEventListener('resize', addMobileLabels);


  // Toggle navigation rail
document.getElementById('navToggle').addEventListener('click', function() {
  document.querySelector('.nav-rail').classList.toggle('expanded');
});

// Close rail when clicking overlay (mobile)
document.getElementById('navOverlay').addEventListener('click', function() {
  document.querySelector('.nav-rail').classList.remove('expanded');
});

// Close rail when clicking outside (desktop)
document.addEventListener('click', function(event) {
  const rail = document.querySelector('.nav-rail');
  const isClickInsideRail = rail.contains(event.target);
  const isClickOnToggle = event.target.closest('#navToggle');
  
  if (!isClickInsideRail && !isClickOnToggle && window.innerWidth > 768) {
    rail.classList.remove('expanded');
  }
});
// Function to load pending journeys when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Fetch pending journeys from Google Sheets web app endpoint
  const driverData = JSON.parse(localStorage.getItem('driverData'));
    
    if (driverData) {
        // Display driver name
        const driverNameElement = document.getElementById('driverName');
        if (driverNameElement) {
            driverNameElement.textContent = driverData.name;
        }
        
        // You can use other data as needed
        console.log('Driver ID:', driverData.id);
        
    } else {
        // If no driver data found, redirect to login
        window.location.href = './index.html';
    }


   const activeSection = document.querySelector('.section.active');
  if (activeSection) {
    const sectionId = activeSection.id;
    const navItems = document.querySelectorAll('.nav-item');
    switch(sectionId) {
      case 'home':
        navItems[0].classList.add('active');
        break;
      case 'fuel':
        navItems[1].classList.add('active');
        break;
      case 'history':
        navItems[2].classList.add('active');
        break;
    }
  }
  
  const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('overlay');

  const vehicles = [
  { name: 'Hycross', number: 'KL02BY3091 ' },
  { name: 'Ertiga', number: 'KL23Y0927' }
];

    const vehicleNameSelect = document.getElementById('vehicleName');
  const fuelvehicleNameSelect = document.getElementById('fuelVehicleName');
  
  vehicles.forEach(vehicle => {
    const option = document.createElement('option');
    option.value = vehicle.name;
    option.textContent = vehicle.name;
    vehicleNameSelect.appendChild(option);
    fuelvehicleNameSelect.appendChild(option);
  });



    if (menuToggle && sidebar) {
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    let loaderMinimumTime = 500; // 500ms minimum show time
    let loaderShownTime;
    // Loader functions
    window.showLoader = function() {
        loaderShownTime = Date.now();
        document.getElementById('loader').style.display = 'flex';
    };

    window.hideLoader = function() {
        //const elapsed = Date.now() - loaderShownTime;
       const elapsed = 0;
    const remaining = loaderMinimumTime - elapsed;
    
    if (remaining > 0) {
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
        }, remaining);
    } else {
        document.getElementById('loader').style.display = 'none';
    }
    };

    // Show loader on initial page load
    showLoader();
   // window.addEventListener('load', hideLoader);


  const driverId= driverData.id;
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=pending-journeys&driverId=${encodeURIComponent(driverId)}`)
    .then(showLoader())
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Pending journeys data:", data);
      
      // Get the table body element
      const tableBody = document.querySelector('#home tbody');
      
      // Clear any existing rows
      tableBody.innerHTML = '';
      
      // Check if there's any data
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">No pending journeys found</td></tr>';
        return;
      }
      
      // Add each journey as a row in the table
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        // Adjust these property names to match your actual column headers
        row.innerHTML = `
          <td>${journey['VehicleNumber'] || ''}</td>
          <td>${journey['StartPoint'] || ''}</td>
          <td>${journey['StartKM'] || ''}</td>
          <td>${journey['StartTime'] || ''}</td>
          <td>
            <button class="btn btn-primary complete-btn" data-id="${journey['TravelID'] || ''}">
              Complete
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to complete buttons
      document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const travelId = this.getAttribute('data-id');
          completeJourney(travelId);
        });
      });
    })
    .catch(error => {
      console.error("Error loading pending journeys:", error);
      document.querySelector('#home tbody').innerHTML = `
        <tr>
          <td colspan="5">Error loading data. Please try again later.</td>
        </tr>
      `;
    })
    .finally(hideLoader());
});

function updateVehicleNumber() {
   const vehicles = [
  { name: 'Hycross', number: 'KL02BY3091 ' },
  { name: 'Ertiga', number: 'KL23Y0927' }
];
  const selectedName = document.getElementById('vehicleName').value;
  const fuelselectedName = document.getElementById('fuelVehicleName').value;
  const vehicle = vehicles.find(v => v.name === selectedName);
   const fuelvehicle = vehicles.find(v => v.name === fuelselectedName);
  document.getElementById('vehicleNumber').value = vehicle ? vehicle.number : '';
  document.getElementById('fuelVehicleNumber').value = fuelvehicle ? fuelvehicle.number : '';
}


// Function to mark a journey as complete
async function completeJourney(travelId) {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId= driverData.id;
   fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=complete-journey&travelId=${encodeURIComponent(travelId)}&driverId=${encodeURIComponent(driverId)}`)
  .then(showLoader())
     .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
  })
  .then(data => {
      if (!data.success) {
        throw new Error(data.message || "Journey not found");
      }
      
      const journey = data.data;
      console.log("Journey details:", journey);
    
    // Populate the form fields
      document.getElementById('travelId').value = travelId;
      document.getElementById('completeVehicleNumber').value = journey.VehicleNumber || '';
      document.getElementById('completeVehicleName').value = journey.VehicleName || '';
      document.getElementById('completeStartPoint').value = journey.StartPoint || '';
      document.getElementById('completeStartKm').value = journey.StartKM || '';
      
      // Format the time (assuming it comes in ISO format)
      const startTime = journey.StartTime ? new Date(journey.StartTime) : new Date();
      const formattedTime = startTime.toTimeString().substring(0, 5);
      document.getElementById('completeStartTime').value = formattedTime;
      
      document.getElementById('completePassengerCount').value = journey.PassengerCount || '';
      document.getElementById('completePassengerName').value = journey.PassengerName || '';
      document.getElementById('completePassengerPhone').value = journey.PassengerPhone || '';
      
      // Clear the completion fields
      document.getElementById('completeEndPoint').value = '';
      document.getElementById('completeEndKm').value = '';
      document.getElementById('completeEndTime').value = '';
      
      // Show the complete journey section
      showSection('completeJourney');

  })
  .catch(error => {
    console.error("Error fetching journey details:", error);
    showPopup('Error', 'Error loading journey details. Please try again.');
    return;
  })
  .finally(hideLoader());
}

// Function to close the modal
function closeModal() {
  const modal = document.getElementById('completeJourneyModal');
  if (modal) {
    modal.remove();
  }
}

// Function to submit the completed journey
async function submitCompletedJourney() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId = driverData.id;
  
  // Get all form values
  const travelId = document.getElementById('travelId').value;
  const vehicleNumber = document.getElementById('completeVehicleNumber').value;
  const vehicleName = document.getElementById('completeVehicleName').value;
  const startPoint = document.getElementById('completeStartPoint').value;
  const startKm = document.getElementById('completeStartKm').value;
  const startTime = document.getElementById('completeStartTime').value;
  const passengerCount = document.getElementById('completePassengerCount').value;
  const passengerName = document.getElementById('completePassengerName').value;
  const passengerPhone = document.getElementById('completePassengerPhone').value;
  const endPoint = document.getElementById('completeEndPoint').value;
  const endKm = document.getElementById('completeEndKm').value;
  const endTime = document.getElementById('completeEndTime').value;

  // Validate required fields
  if (!endPoint || !endKm || !endTime) {
    showPopup('Validation Error', 'Please fill in all completion details');
    return;
  }

  // Create completion data object
  const completionData = {
    type: 'submit-complete-journey',
    travelId: travelId,
    driverId: driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone,
    endPoint: endPoint,
    endKm: endKm,
    endTime: endTime
  };

  // Show loading state
  const submitBtn = document.querySelector('#completeJourneyForm button[type="button"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  // Send data to Google Sheets web app
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    mode: 'no-cors',
    body: JSON.stringify(completionData)
  })
  .then(showLoader())
  .then(response => response.text())
  .then(result => {
    console.log("Journey completion result:", result);
    showPopup('Success', 'Journey completed successfully!');
    closeModal();
    location.reload();
  })
  .catch(error => {
    console.error("Error completing journey:", error);
    showPopup('Error', 'Error completing journey. Please try again.');
  })
  .finally(hideLoader());
}

// Function to save journey as pending
async function saveAsPending() {
  // Get form values
   const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverName = driverData.name;
  const driverId= driverData.id;
  const driverPhone = driverData.phoneNumber;
  const vehicleNumber = document.getElementById('vehicleNumber').value;
  const vehicleName = document.getElementById('vehicleName').value;
  const startPoint = document.getElementById('startPoint').value;
  const startKm = document.getElementById('startKm').value;
  const startTime = document.getElementById('startTime').value;
  const passengerCount = document.getElementById('passengerCount').value;
  const passengerName = document.getElementById('passengerName').value;
  const passengerPhone = document.getElementById('passengerPhone').value;

  // Validate required fields
  if (!vehicleNumber || !startPoint || !startKm || !startTime) {
   showPopup('Validation Error', 'Please fill in all required fields');
    return;
  }

  // Create journey data object
  const journeyData = {
    type: 'add-pending-journey',
    driverName:driverName,
    driverPhone:driverPhone,
    driverId:driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone
  };

  // Send data to Google Sheets web app
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(journeyData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(showLoader())
  .then(response =>response.text())
  .then(result => {
    console.log("Save as Pending result:", result);
    showPopup('Success', 'Journey saved as pending successfully!');
    document.getElementById('journeyForm').reset();
    showSection('home');
    location.reload();
  })
  .catch(error => {
    console.error("Error saving pending journey:", error);
    showPopup('Error', 'Error saving journey as pending. Please try again.');
    return;
  }).finally(hideLoader());
}


// Function to load completed journeys when History section is shown
function loadCompletedJourneys() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    console.error('No driver data found');
    return;
  }

  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=history-journey&driverId=${encodeURIComponent(driverData.id)}`)
    .then(showLoader())
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Completed journeys data:", data);
      const tableBody = document.querySelector('#completedTripsTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="15">No completed journeys found</td></tr>';
        return;
      }
      
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${journey.TravelID || ''}</td>
          <td>${journey.Date || ''}</td>
          <td>${journey.VehicleNumber || ''}</td>
          <td>${journey.VehicleName || ''}</td>
          <td>${journey.StartPoint || ''}</td>
          <td>${journey.EndPoint || ''}</td>
          <td>${journey.StartKM || ''}</td>
          <td>${journey.EndKM || ''}</td>
          <td>${formatTime(journey.StartTime)}</td>
          <td>${formatTime(journey.EndTime)}</td>
          <td>${journey.NoPassengers || ''}</td>
          <td>${journey.PassengerName || ''}</td>
          <td>${journey.PassengerPhone || ''}</td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => {
      console.error("Error loading completed journeys:", error);
      document.querySelector('#completedTripsTable tbody').innerHTML = `
        <tr>
          <td colspan="15">Error loading data. Please try again later.</td>
        </tr>
      `;
    }).finally(hideLoader());
}

function formatTime(timeString) {
  // Handle null/undefined/empty values
  if (!timeString) return '';
  
  // Convert to string if it isn't already
  timeString = String(timeString);
  
  // If it's already in HH:MM format
  if (timeString.includes(':')) return timeString;
  
  // If it's in ISO format (from spreadsheet)
  if (timeString.includes('T')) {
    try {
      const date = new Date(timeString);
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch (e) {
      return timeString; // Return original if date parsing fails
    }
  }
  
  return timeString;
}

async function submitFuelEntry() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    showPopup('Authentication Error', 'Please login again');
    return;
  }

  // Get form values
  const fuelId = generateFuelId();
  const vehicleNumber = document.getElementById('fuelVehicleNumber').value;
  const vehicleName = document.getElementById('fuelVehicleName').value;
  const date = document.getElementById('fuelDate').value;
  const invoiceNumber = document.getElementById('fuelInvoiceNumber').value;
  const fuelType = document.getElementById('fuelType').value;
  const amount = document.getElementById('fuelAmount').value;
  const liters = document.getElementById('fuelLiters').value;
  const currentKm = document.getElementById('fuelCurrentKm').value;
  const billImage = document.getElementById('fuelBillImage').files[0];

  // Validate required fields
  if (!vehicleNumber || !date || !invoiceNumber || !fuelType || !amount || !liters || !currentKm || !billImage) {
    showPopup('Validation Error', 'Please fill in all required fields');
    return;
  }

  // Show loading state
  const submitBtn = document.querySelector('#fuelForm button');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  
    // Create FormData for proper file upload
     const formData = {
    type: 'add-fuel-entry',
    fuelId:fuelId,
    driverId:driverData.id,
    driverName:driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    date: date,
    invoiceNumber: invoiceNumber,
    fuelType: fuelType,
    amount: amount,
    liters: liters,
    currentKm: currentKm,
    billImage: billImage
  };

   fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(formData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(showLoader())
  .then(response =>response.text())
  .then(result => {
    console.log("Save as Fuel result:", result);
    showPopup('Success', 'Fuel saved successfully!');
    document.getElementById('journeyForm').reset();
    showSection('home');
    location.reload();
  })
  .catch(error => {
    console.error("Error saving Fuel:", error);
    showPopup('Error', 'Error saving Fuel. Please try again.');
    return;
  }).finally(hideLoader());
}

  
function generateFuelId() {
  const timestamp = Date.now().toString(36);
  const random = Math.random().toString(36).substr(2, 5);
  return `FUEL-${timestamp}-${random}`.toUpperCase();
}


// Custom Popup Function
function showPopup(title, message) {
  return new Promise((resolve) => {
    const popup = document.getElementById('customPopup');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    
    popupTitle.textContent = title;
    popupMessage.textContent = message;
    popup.classList.add('active');
    
    // Create a function to handle closing
    const closePopup = () => {
      popup.classList.remove('active');
      resolve(); // Resolve the promise when popup is closed
      
      // Remove event listeners to prevent memory leaks
      document.getElementById('popupOk').removeEventListener('click', closePopup);
      document.getElementById('popupClose').removeEventListener('click', closePopup);
      popup.removeEventListener('click', outsideClick);
    };
    
    // Handle outside clicks
    const outsideClick = (e) => {
      if (e.target === popup) {
        closePopup();
      }
    };
    
    // Add event listeners
    document.getElementById('popupOk').addEventListener('click', closePopup);
    document.getElementById('popupClose').addEventListener('click', closePopup);
    popup.addEventListener('click', outsideClick);
  });
}
  
</script>


  <!-- Custom Popup Structure -->
<div class="popup-overlay" id="customPopup">
  <div class="popup-container">
    <button class="popup-close" id="popupClose">&times;</button>
    <h3 class="popup-title" id="popupTitle">Message</h3>
    <div class="popup-message" id="popupMessage"></div>
    <div class="popup-buttons">
      <button class="popup-button" id="popupOk">OK</button>
    </div>
  </div>
</div>
  
</body>
</html>
