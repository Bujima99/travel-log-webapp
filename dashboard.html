<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" href="./img/travelicon.png">
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/general.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="./js/app.js"></script>
<script src="./js/general.js"></script>
</head>
  <style>
    .suggestions {
      left: 1rem;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    max-height: 180px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    width: calc(100% - 32px);
    margin-top: -11px;
}

.suggestion-item {
  padding: 10px 12px;
  cursor: pointer;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-item:hover {
  background-color: #f7f7f7;
}

  </style>
<body>
  
<div class="loader-container" id="loader">
    <div class="loader">
        <svg class="car" width="102" height="40" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(2 1)" stroke="#002742" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round">
                <path class="car__body" d="M47.293 2.375C52.927.792 54.017.805 54.017.805c2.613-.445 6.838-.337 9.42.237l8.381 1.863c2.59.576 6.164 2.606 7.98 4.531l6.348 6.732 6.245 1.877c3.098.508 5.609 3.431 5.609 6.507v4.206c0 .29-2.536 4.189-5.687 4.189H36.808c-2.655 0-4.34-2.1-3.688-4.67 0 0 3.71-19.944 14.173-23.902zM36.5 15.5h54.01" stroke-width="3"/>
                <ellipse class="car__wheel--left" stroke-width="3.2" fill="#FFF" cx="83.493" cy="30.25" rx="6.922" ry="6.808"/>
                <ellipse class="car__wheel--right" stroke-width="3.2" fill="#FFF" cx="46.511" cy="30.25" rx="6.922" ry="6.808"/>
                <path class="car__line car__line--top" d="M22.5 16.5H2.475" stroke-width="3"/>
                <path class="car__line car__line--middle" d="M20.5 23.5H.4755" stroke-width="3"/>
                <path class="car__line car__line--bottom" d="M25.5 9.5h-19" stroke-width="3"/>
            </g>
        </svg>
    </div>
</div>
<div class="nav-rail">
  <div class="nav-header">
    <div class="user-info">
      <div class="avatar"></div>
      <span id="driverName"></span>
    </div>
    <button class="nav-toggle" id="navToggle">
      <span class="material-symbols-outlined">menu</span>
    </button>
  </div>
  
 <nav class="nav-menu">
  <ul>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('home')" class="nav-item active">
        <span class="material-symbols-outlined">home</span>
        <span class="nav-text">Home</span>
      </a>
    </li>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('fuel')" class="nav-item">
        <span class="material-symbols-outlined">local_gas_station</span>
        <span class="nav-text">Fuel</span>
      </a>
    </li>
    <li>
      <a href="#" onclick="event.preventDefault(); showSection('history')" class="nav-item">
        <span class="material-symbols-outlined">directions_car</span>
        <span class="nav-text">Journeys</span>
      </a>
    </li>
    <li>
  <a href="#" onclick="event.preventDefault(); showSection('service')" class="nav-item">
    <span class="material-symbols-outlined">build</span>
    <span class="nav-text">Services</span>
  </a>
</li>
    <li>
  <a href="#" onclick="event.preventDefault(); showSection('profile')" class="nav-item">
    <span class="material-symbols-outlined">account_circle</span>
    <span class="nav-text">Profile</span>
  </a>
</li>
  </ul>

    <!--   div  the logout button at  bottom -->
  <div class="nav-footer">
    <a href="#" onclick="logout()" class="nav-item">
      <span class="material-symbols-outlined">logout</span>
      <span class="nav-text">Logout</span>
    </a>
  </div>
   
</nav>
</div>


<div class="nav-overlay" id="navOverlay"></div>
<div class="main-content">

  <div id="home" class="section active">
    <h2 class="activeJourney">Active Journeys</h2>

    <!-- Add this inside the #home section, right after the <h2>Active Journeys</h2> -->
<div id="guestTimerContainer" class="guest-timer-container" style="display: none;">
  <div class="timer">
    <div id="hour">
      <span id="hour_1">0</span>
      <span id="hour_0">0</span>
    </div>
    <div class="colon">:</div>
    <div id="min">
      <span id="min_1">0</span>
      <span id="min_0">0</span>
    </div>
    <div class="colon">:</div>
    <div id="sec">
      <span id="sec_1">0</span>
      <span id="sec_0">0</span>
    </div>
  </div>
  <div class="timer-label">Guest Access Expires In</div>
</div>

    
    <div class="table-wrapper">
    <table class="fl-table" id="pendingTable">
        <thead>
        <tr>
            <th>Vehicle</th>
            <th>Start Point</th>
            <th>Start KM</th>
            <th>Start Time</th>
            <th>Action</th>
        </tr>
        </thead>
      <tbody id="journeys-table-body">
        <!-- Data will  inserted here by JavaScript -->
    </tbody>
    </table>
  </div>

<!-- Replace the existing FAB button with this -->
<div class="fab-wrapper">
  <input type="checkbox" id="fabToggle" />
  <div class="fab">
    <span class="plus-icon">＋</span>
  </div>
  <div class="fab-actions">
    <a href="#" onclick="event.preventDefault(); showSection('addJourney')" class="fab-action">
      <span class="material-symbols-outlined">directions_car</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addFuelForm');" class="fab-action">
      <span class="material-symbols-outlined">local_gas_station</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addServiceForm');" class="fab-action">
    <span class="material-symbols-outlined">build</span>
  </a>
  </div>
</div>
    
  </div>
  
  <div id="addJourney" class="section">
    <h2>Log New Journey</h2>
    <form id="journeyForm">
      <select id="vehicleName" required onchange="updateVehicleNumber()">
        <option value="">Select Vehicle</option>
      </select>
      <div id="vehicleNameError" class="validation-message"></div>
      
      <input type="text" id="vehicleNumber" placeholder="Vehicle Number" readonly required>
      <div id="vehicleNumberError" class="validation-message"></div>
      <div style="position: relative;">
      <input type="text" id="startPoint" placeholder="Starting Point" required>
      <div id="startSuggestions" class="suggestions"></div>
      </div>
      <div id="startPointError" class="validation-message"></div>
      
      <input type="number" id="startKm" placeholder="Starting KM" required>
      <div id="startKmError" class="validation-message"></div>
      
      <input type="time" id="startTime" required>
      <div id="startTimeError" class="validation-message"></div>
      
      <input type="number" id="passengerCount" placeholder="No. of Passengers" required>
      <div id="passengerCountError" class="validation-message"></div>
      
      <input type="text" id="passengerName" placeholder="One Passenger Name" required>
      <div id="passengerNameError" class="validation-message"></div>
      
      <input type="tel" id="passengerPhone" placeholder="Passenger Phone (10-digits)" required>
      <div id="passengerPhoneError" class="validation-message"></div>

      <textarea rows="4" id="purpose" placeholder="Purpose of the journey" required></textarea>
      <div id="purposeError" class="validation-message"></div>
      
      <button type="button" onclick="validateJourneyForm()">Start Trip</button>
    </form>
  </div>

 <div id="fuel" class="section">
  <h2>Fuel Tracker</h2>
  <div class="table-wrapper">
    <table class="fl-table" id="fuelTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Vehicle</th>
          <th>Invoice No</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Liters</th>
          <th>KM Reading</th>
          <th>Bill</th>
        </tr>
      </thead>
      <tbody id="fuel-entries-body">
        <!-- Data will be inserted here by JavaScript -->
      </tbody>
    </table>
  </div>

   <div class="fab-wrapper">
  <input type="checkbox" id="fabToggle" />
  <div class="fab">
    <span class="plus-icon">＋</span>
  </div>
  <div class="fab-actions">
    <a href="#" onclick="event.preventDefault(); showSection('addJourney')" class="fab-action">
      <span class="material-symbols-outlined">directions_car</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addFuelForm');" class="fab-action">
      <span class="material-symbols-outlined">local_gas_station</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addServiceForm');" class="fab-action">
    <span class="material-symbols-outlined">build</span>
  </a>
  </div>
</div>
   
  </div>

  
  <div id="addFuelForm" class="section">
    <h2>New Fuel Record</h2>
    <form id="fuelForm" enctype="multipart/form-data">
      <select id="fuelVehicleName" required onchange="updateVehicleNumber()">
        <option value="">Select Vehicle</option>
      </select>
      <div id="fuelVehicleNameError" class="validation-message"></div>
      
      <input type="text" id="fuelVehicleNumber" placeholder="Vehicle Number" readonly required>
      <div id="fuelVehicleNumberError" class="validation-message"></div>
      
      <input type="date" id="fuelDate" required>
      <div id="fuelDateError" class="validation-message"></div>
      
      <input type="text" id="fuelInvoiceNumber" placeholder="Invoice Number" required>
      <select id="fuelType" required>
        <option value="">Select Fuel Type</option>
        <option value="Petrol">Petrol</option>
        <option value="Diesel">Diesel</option>
        <option value="CNG">CNG</option>
        <option value="Electric">Electric</option>
      </select>
       <div id="fuelTypeError" class="validation-message"></div>
      
      <input type="number" id="fuelAmount" placeholder="Amount" step="0.01" required>
      <div id="fuelAmountError" class="validation-message"></div>
      
      <input type="number" id="fuelQuantity" placeholder="Liters" step="0.01" required>
      <div id="fuelQuantityError" class="validation-message"></div>
      
      <input type="number" id="fuelCurrentKm" placeholder="Current KM" required>
       <div id="fuelCurrentKmError" class="validation-message"></div>
      
      <input type="file" id="fuelBillImage" accept="image/*" required>
       <div id="fuelBillImageError" class="validation-message"></div>
      
      <div class="form-buttons">
        <button type="button" onclick="submitFuelEntry()">Submit</button>
        <button type="button" class="cancel-btn" onclick="hideAddFuelForm()">Cancel</button>
      </div>
    </form>
  </div>


 <div id="history" class="section">
  <h2>Journey Logs</h2>
   <div class="table-wrapper">
  <table class="fl-table" id="completedTripsTable">
    <thead>
      <tr>
        <th>Travel ID</th>
        <th>Date</th>
        <th>Vehicle Number</th>
        <th>Vehicle Name</th>
        <th>Start Point</th>
        <th>End Point</th>
        <th>Start KM</th>
        <th>End KM</th>
         <th>Total KM Travelled</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Passenger Count</th>
        <th>Passenger Name</th>
        <th>Passenger Phone</th>
        <th>Purpose of Travel</th>
        <th>Fuel Filled</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
   </div>

   <div class="fab-wrapper">
  <input type="checkbox" id="fabToggle" />
  <div class="fab">
    <span class="plus-icon">＋</span>
  </div>
  <div class="fab-actions">
    <a href="#" onclick="event.preventDefault(); showSection('addJourney')" class="fab-action">
      <span class="material-symbols-outlined">directions_car</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addFuelForm');" class="fab-action">
      <span class="material-symbols-outlined">local_gas_station</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addServiceForm');" class="fab-action">
    <span class="material-symbols-outlined">build</span>
  </a>
  </div>
</div>

</div>


<div id="service" class="section">
  <h2>Service Records</h2>
  <div class="table-wrapper">
    <table class="fl-table" id="serviceTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Vehicle</th>
          <th>Invoice No</th>
          <th>Type</th>
          <th>Amount</th>
          <th>KM Reading</th>
          <th>Next Service</th>
          <th>Workshop</th>
           <th>Remarks</th>
          <th>Bill</th>
        </tr>
      </thead>
      <tbody id="service-entries-body">
        <!-- Data will be inserted here by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Replace the existing FAB button with this -->
<div class="fab-wrapper">
  <input type="checkbox" id="fabToggle" />
  <div class="fab">
    <span class="plus-icon">＋</span>
  </div>
  <div class="fab-actions">
    <a href="#" onclick="event.preventDefault(); showSection('addJourney')" class="fab-action">
      <span class="material-symbols-outlined">directions_car</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addFuelForm');" class="fab-action">
      <span class="material-symbols-outlined">local_gas_station</span>
    </a>
    <a href="#" onclick="event.preventDefault(); event.stopPropagation(); showSection('addServiceForm');" class="fab-action">
    <span class="material-symbols-outlined">build</span>
  </a>
  </div>
</div>
  
</div>

<!-- Add this section for New Service Form (around line 280) -->
<div id="addServiceForm" class="section">
  <h2>New Service Record</h2>
  <form id="serviceForm" enctype="multipart/form-data">
    <select id="serviceVehicleName" required onchange="updateVehicleNumber()">
      <option value="">Select Vehicle</option>
    </select>
    <div id="serviceVehicleNameError" class="validation-message"></div>
    <input type="text" id="serviceVehicleNumber" placeholder="Vehicle Number" readonly required>
     <div id="serviceVehicleNumberError" class="validation-message"></div>
    
    <input type="date" id="serviceDate" required>
     <div id="serviceDateError" class="validation-message"></div>
    
    <input type="text" id="serviceInvoiceNumber" placeholder="Invoice Number" required>
    <div id="serviceInvoiceNumberError" class="validation-message"></div>
    
    <select id="serviceType" required onchange="toggleNextServiceDate()">
      <option value="">Select Service Type</option>
      <option value="Service">Service</option>
      <option value="Maintainance">Maintainance</option>
    </select>
    <div id="serviceTypeError" class="validation-message"></div>
    
    <input type="number" id="serviceAmount" placeholder="Amount" step="0.01" required>
    <div id="serviceAmountError" class="validation-message"></div>
    
    <input type="number" id="serviceCurrentKm" placeholder="Current KM" required>
     <div id="serviceCurrentKmError" class="validation-message"></div>
    
    <div id="nextServiceDateContainer" style="display:none;">
      <input type="text" id="nextServiceDate" placeholder="Next Service KM">
    </div>
    <div id="nextServiceDateError" class="validation-message"></div>
    
    <input type="text" id="serviceWorkshop" placeholder="Workshop Name" required>
     <div id="serviceWorkshopError" class="validation-message"></div>
    
    <div style="position: relative;">
    <input type="text" id="serviceWorkshopLocation" placeholder="Workshop Location" required>
      <div id="serviceWorkshopLocationSuggestions" class="suggestions"></div>
       </div>
     <div id="serviceWorkshopLocationError" class="validation-message"></div>
    
    <textarea rows="4" id="serviceRemarks" placeholder="Remarks (if any)" required></textarea>
    <div id="serviceRemarksError" class="validation-message"></div>
    
    <input type="file" id="serviceBillImage" accept="image/*" required>
     <div id="serviceBillImageError" class="validation-message"></div>
    
    <div class="form-buttons">
      <button type="button" onclick="submitServiceEntry()">Submit</button>
      <button type="button" class="cancel-btn" onclick="hideAddServiceForm()">Cancel</button>
    </div>
  </form>
</div>

<div id="profile" class="section">
  <h2>Driver Profile</h2>
  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar">
        <span class="material-symbols-outlined">account_circle</span>
      </div>
      <h3 id="profileDriverName"></h3>
      <span class="profile-badge" id="profileBadge"></span>
    </div>
    
    <div class="profile-details">
      <div class="detail-row">
        <span class="detail-label">Driver ID:</span>
        <span class="detail-value" id="profileDriverId"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Username:</span>
        <span class="detail-value" id="profileUsername"></span>
        <span class="edit-icon" onclick="enableProfileEdit()">
          <span class="material-symbols-outlined">edit</span>
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Password:</span>
        <span class="detail-value" id="profilePassword"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Phone:</span>
        <span class="detail-value" id="profilePhone"></span>
      </div>
    </div>
    
    <div class="profile-actions" id="profileEditActions" style="display: none;">
      <button class="btn" onclick="saveProfileChanges()">Save Changes</button>
      <button class="btn cancel" onclick="cancelProfileEdit()">Cancel</button>
    </div>
  </div>
</div>

<div id="completeJourney" class="section">
  <h2>Complete Journey</h2>
  <form id="completeJourneyForm">
    <input type="hidden" id="travelId">
    
    <div class="form-group">
      <label>Vehicle Name:</label>
      <select id="completeVehicleName" required onchange="updateVehicleNumber()">
        <option value="">Select Vehicle</option>
      </select>
      <div id="completeVehicleNameError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Vehicle Number:</label>
      <input type="text" id="completeVehicleNumber" placeholder="Vehicle Number" readonly required>
      <div id="completeVehicleNumberError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Start Point:</label>
      <input type="text" id="completeStartPoint" required>
      <div id="completeStartPointError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Start KM:</label>
      <input type="number" id="completeStartKm" required>
      <div id="completeStartKmError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Start Time:</label>
      <input type="time" id="completeStartTime" required>
      <div id="completeStartTimeError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Passenger Count:</label>
      <input type="number" id="completePassengerCount" required>
      <div id="completePassengerCountError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Passenger Name:</label>
      <input type="text" id="completePassengerName" required>
      <div id="completePassengerNameError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>Passenger Phone:</label>
      <input type="tel" id="completePassengerPhone" required>
      <div id="completePassengerPhoneError" class="validation-message"></div>
    </div>

    <div class="form-group">
      <label>Purpose:</label>
      <textarea rows="4" id="completePurpose" required></textarea>
      <div id="completePurposeError" class="validation-message"></div>
    </div>
    
    <!-- Additional fields for completion -->
    <div class="form-group">
      <label>End Point:</label>
      <div style="position: relative;">
      <input type="text" id="completeEndPoint" required>
      <div id="endSuggestions" class="suggestions"></div>
      </div>
      <div id="completeEndPointError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>End KM:</label>
      <input type="number" id="completeEndKm" required>
      <div id="completeEndKmError" class="validation-message"></div>
    </div>
    
    <div class="form-group">
      <label>End Time:</label>
      <input type="time" id="completeEndTime" required>
      <div id="completeEndTimeError" class="validation-message"></div>
    </div>

    <div class="form-group">
      <label>Fuel Filled:</label>
      <select id="completeFuelFilled" required>
        <option value="">Select Option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <div id="completeFuelFilledError" class="validation-message"></div>
    </div>
    
    <button type="button" onclick="validateCompleteJourneyForm()">Complete Journey</button>
    <button type="button" class="cancel-btn" onclick="showSection('home')">Cancel</button>
  </form>
</div>

</div>
  <script src="js/app.js"></script>
  
<script>

  // Add data labels for mobile view
function addMobileLabels() {
    if (window.innerWidth <= 767) {
        const headers = document.querySelectorAll('.fl-table thead th');
        const rows = document.querySelectorAll('.fl-table tbody tr');
        
        headers.forEach((header, index) => {
            const label = header.textContent;
            rows.forEach(row => {
                const cell = row.querySelectorAll('td')[index];
                if (cell) {
                    cell.setAttribute('data-label', label);
                }
            });
        });
    }
}

// Run on load and resize
window.addEventListener('load', addMobileLabels);
window.addEventListener('resize', addMobileLabels);


  // Toggle navigation rail
document.getElementById('navToggle').addEventListener('click', function() {
  document.querySelector('.nav-rail').classList.toggle('expanded');
});

// Close rail when clicking overlay (mobile)
document.getElementById('navOverlay').addEventListener('click', function() {
  document.querySelector('.nav-rail').classList.remove('expanded');
});

// Close rail when clicking outside (desktop)
document.addEventListener('click', function(event) {
  const rail = document.querySelector('.nav-rail');
  const isClickInsideRail = rail.contains(event.target);
  const isClickOnToggle = event.target.closest('#navToggle');
  
  if (!isClickInsideRail && !isClickOnToggle && window.innerWidth > 768) {
    rail.classList.remove('expanded');
  }
});
// Function to load pending journeys when the page loads
document.addEventListener('DOMContentLoaded', function() {

  // Initialize back button handling for protected pages
  const driverData = JSON.parse(localStorage.getItem('driverData'));

  // Handle post-logout cleanup
  if (sessionStorage.getItem('justLoggedOut')) {
    sessionStorage.removeItem('justLoggedOut');
    resetLoginForms();
  }

  // Set up for both start and end inputs
setupAutocomplete("startPoint", "startSuggestions");
setupAutocomplete("completeEndPoint", "endSuggestions");
setupAutocomplete("serviceWorkshopLocation", "serviceWorkshopLocationSuggestions");
  
    
    if (driverData) {
        // Display driver name
        const driverNameElement = document.getElementById('driverName');
        if (driverNameElement) {
            driverNameElement.textContent = driverData.name;
        }
        
        // You can use other data as needed
        console.log('Driver ID:', driverData.id);
        // Add this line after you load the driver data
      checkGuestTimer();

        
    } else {
        // If no driver data found, redirect to login
        window.location.href = './index.html';
    }


   const activeSection = document.querySelector('.section.active');
  if (activeSection) {
    const sectionId = activeSection.id;
    const navItems = document.querySelectorAll('.nav-item');
    switch(sectionId) {
      case 'home':
        navItems[0].classList.add('active');
        break;
      case 'fuel':
        navItems[1].classList.add('active');
        break;
      case 'history':
        navItems[2].classList.add('active');
        break;
    }
  }

  const fabToggle = document.getElementById('fabToggle');
  const fabWrapper = document.querySelector('.fab-wrapper');
  const fabActions = document.querySelector('.fab-actions');

  // Close when clicking outside
  document.addEventListener('click', function(event) {
    const isClickInsideFab = fabWrapper.contains(event.target);
    const isFabToggle = event.target === fabToggle || event.target.closest('.fab');
    
    if (!isClickInsideFab && fabToggle.checked) {
      fabToggle.checked = false;
    }
  });

 
  
  const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('overlay');
/*
  const vehicles = [
  { name: 'Hycross', number: 'KL02BY3091 ' },
  { name: 'Ertiga', number: 'KL23Y0927' }
];

    const vehicleNameSelect = document.getElementById('vehicleName');
  const fuelvehicleNameSelect = document.getElementById('fuelVehicleName');
  const serviceVehicleNameSelect = document.getElementById('serviceVehicleName');
  
  vehicles.forEach(vehicle => {
    const option1 = document.createElement('option');
  option1.value = vehicle.name;
  option1.textContent = vehicle.name;
  vehicleNameSelect.appendChild(option1);
  
 
  const option2 = document.createElement('option');
  option2.value = vehicle.name;
  option2.textContent = vehicle.name;
  fuelvehicleNameSelect.appendChild(option2);

  const option3 = document.createElement('option');
  option3.value = vehicle.name;
  option3.textContent = vehicle.name;
  serviceVehicleNameSelect.appendChild(option3);
  });

  */

  document.getElementById('vehicleName').addEventListener('change', function() {
    validateRequired(this.value, 'vehicleName');
  });
  
  document.getElementById('startPoint').addEventListener('input', function() {
    validateRequired(this.value, 'startPoint');
  });
  
  document.getElementById('startKm').addEventListener('input', function() {
    validateNumber(this.value, 'startKm');
  });
  
  document.getElementById('startTime').addEventListener('change', function() {
    validateRequired(this.value, 'startTime');
  });
  
  document.getElementById('passengerCount').addEventListener('input', function() {
    validateNumber(this.value, 'passengerCount');
  });
  
  document.getElementById('passengerName').addEventListener('input', function() {
    validateName(this.value, 'passengerName');
  });
  
  document.getElementById('passengerPhone').addEventListener('input', function() {
    validatePhone(this.value, 'passengerPhone');
  });

  // Add validation for purpose field
  document.getElementById('purpose').addEventListener('input', function() {
     validateRequired(this.value, 'purpose');
  });

  // Vehicle selection validation
  document.getElementById('completeVehicleName').addEventListener('change', function() {
    validateRequired(this.value, 'completeVehicleName');
  });
  
  // Start point validation (alphabets only)
  document.getElementById('completeStartPoint').addEventListener('input', function() {
    validateRequired(this.value, 'completeStartPoint');
  });
  
  // Start KM validation (positive number)
  document.getElementById('completeStartKm').addEventListener('input', function() {
    validateNumber(this.value, 'completeStartKm');
  });
  
  // Start time validation
  document.getElementById('completeStartTime').addEventListener('change', function() {
    validateRequired(this.value, 'completeStartTime');
  });
  
  // Passenger count validation (positive number)
  document.getElementById('completePassengerCount').addEventListener('input', function() {
    validateNumber(this.value, 'completePassengerCount');
  });
  
  // Passenger name validation (alphabets only)
  document.getElementById('completePassengerName').addEventListener('input', function() {
    validateName(this.value, 'completePassengerName');
  });
  
  // Passenger phone validation (10 digits)
  document.getElementById('completePassengerPhone').addEventListener('input', function() {
    validatePhone(this.value, 'completePassengerPhone');
  });
  
  // Purpose validation
  document.getElementById('completePurpose').addEventListener('input', function() {
    validateRequired(this.value, 'completePurpose');
  });
  
  // End point validation (alphabets only)
  document.getElementById('completeEndPoint').addEventListener('input', function() {
    validateRequired(this.value, 'completeEndPoint');
  });
  
  // End KM validation (positive number)
  document.getElementById('completeEndKm').addEventListener('input', function() {
    validateNumber(this.value, 'completeEndKm');
  });
  
  // End time validation
  document.getElementById('completeEndTime').addEventListener('change', function() {
    validateRequired(this.value, 'completeEndTime');
  });
  
  // Fuel filled validation
  document.getElementById('completeFuelFilled').addEventListener('change', function() {
    validateRequired(this.value, 'completeFuelFilled');
  });


  document.getElementById('serviceVehicleName').addEventListener('change', function() {
  validateRequired(this.value, 'serviceVehicleName');
});

document.getElementById('serviceDate').addEventListener('change', function() {
  validateRequired(this.value, 'serviceDate');
});

document.getElementById('serviceInvoiceNumber').addEventListener('input', function() {
  validateRequired(this.value, 'serviceInvoiceNumber');
});

document.getElementById('serviceType').addEventListener('change', function() {
  validateRequired(this.value, 'serviceType');
});

document.getElementById('serviceAmount').addEventListener('input', function() {
  validateNumber(this.value, 'serviceAmount');
});

document.getElementById('serviceCurrentKm').addEventListener('input', function() {
  validateNumber(this.value, 'serviceCurrentKm');
});

document.getElementById('serviceWorkshop').addEventListener('input', function() {
  validateName(this.value, 'serviceWorkshop');
});

document.getElementById('serviceWorkshopLocation').addEventListener('input', function() {
  validateRequired(this.value, 'serviceWorkshopLocation');
});

document.getElementById('serviceRemarks').addEventListener('input', function() {
  validateRequired(this.value, 'serviceRemarks');
});

// Vehicle Name (select) - validate on change
  document.getElementById('fuelVehicleName').addEventListener('change', function() {
    validateRequired(this.value, 'fuelVehicleName');
  });

  // Vehicle Number - validate on change (readonly but just in case)
  document.getElementById('fuelVehicleNumber').addEventListener('change', function() {
    validateRequired(this.value, 'fuelVehicleNumber');
  });

  // Date - validate on change
  document.getElementById('fuelDate').addEventListener('change', function() {
    validateRequired(this.value, 'fuelDate');
  });

  // Amount - validate on input
  document.getElementById('fuelAmount').addEventListener('input', function() {
    const value = this.value;
    if (!value) {
      showError('fuelAmount','Amount is required');
      //document.getElementById('fuelAmountError').textContent = 'Amount is required';
    } else if (isNaN(value) || Number(value) <= 0) {
       showError('fuelAmount','Please enter a valid positive amount');
      //document.getElementById('fuelAmountError').textContent = 'Please enter a valid positive amount';
    } else {
      showError('fuelAmount','');
     // document.getElementById('fuelAmountError').textContent = '';
    }
  });

  // Quantity - validate on input
  document.getElementById('fuelQuantity').addEventListener('input', function() {
    const value = this.value;
    if (!value) {
      showError('fuelQuantity','Quantity is required');
     // document.getElementById('fuelQuantityError').textContent = 'Quantity is required';
    } else if (isNaN(value) || Number(value) <= 0) {
      showError('fuelQuantity','Please enter a valid positive quantity');
     // document.getElementById('fuelQuantityError').textContent = 'Please enter a valid positive quantity';
    } else {
       showError('fuelQuantity','');
     // document.getElementById('fuelQuantityError').textContent = '';
    }
  });

  // Current KM - validate on input
  document.getElementById('fuelCurrentKm').addEventListener('input', function() {
    const value = this.value;
    if (!value) {
      showError('fuelCurrentKm','Current KM is required');
     // document.getElementById('fuelCurrentKmError').textContent = 'Current KM is required';
    } else if (isNaN(value) || Number(value) <= 0) {
      showError('fuelCurrentKm','Please enter a valid positive number');
     // document.getElementById('fuelCurrentKmError').textContent = 'Please enter a valid positive number';
    } else {
      showError('fuelCurrentKm','');
      //document.getElementById('fuelCurrentKmError').textContent = '';
    }
  });

  // Fuel Type (select) - validate on change
  document.getElementById('fuelType').addEventListener('change', function() {
    validateRequired(this.value, 'fuelType');
  });

  // Bill Image - validate on change
  document.getElementById('fuelBillImage').addEventListener('change', function() {
    validateRequired(this.value, 'fuelBillImage');
  });


    if (menuToggle && sidebar) {
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    
   

    // Show loader on initial page load
    showLoader();
   // window.addEventListener('load', hideLoader);
  const driverId= driverData.id;
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=pending-journeys&driverId=${encodeURIComponent(driverId)}`)
    .then(response => response.json())
    .then(data => {
      console.log("Pending journeys data:", data);
      const tableBody = document.querySelector('#home tbody');
      tableBody.innerHTML = '';
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">No pending journeys found</td></tr>';
        return;
      }
      
      // Add each journey as a row in the table
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        // Adjust these property names to match your actual column headers
        row.innerHTML = `
          <td>${journey['VehicleNumber'] || ''}</td>
          <td>${journey['StartPoint'] || ''}</td>
          <td>${journey['StartKM'] || ''}</td>
          <td>${journey['StartTime'] || ''}</td>
          <td>
            <button class="btn btn-primary complete-btn" data-id="${journey['TravelID'] || ''}" style="background:#FFB343;">
              End Trip
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Add event listeners to complete buttons
      document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const travelId = this.getAttribute('data-id');
          completeJourney(travelId);
        });
      });
    })
    .catch(error => {
      console.error("Error loading pending journeys:", error);
      document.querySelector('#home tbody').innerHTML = `
        <tr>
          <td colspan="5">Error loading data. Please try again later.</td>
        </tr>
      `;
    })
    .finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
});


// Add this function to toggle next service date field
function toggleNextServiceDate() {
  const serviceType = document.getElementById('serviceType').value;
  const nextServiceContainer = document.getElementById('nextServiceDateContainer');
  
  if (serviceType === 'Service') {
    nextServiceContainer.style.display = 'block';
    document.getElementById('nextServiceDate').required = true;
  } else {
    nextServiceContainer.style.display = 'none';
    document.getElementById('nextServiceDate').required = false;
    document.getElementById('nextServiceDate').value = '';
  }
}

// Add this function to show/hide service form
function hideAddServiceForm() {
  document.getElementById('addServiceForm').style.display = 'none';
  document.getElementById('serviceForm').reset();
   showSection('home');
}

// Add this function to load service entries
function loadServiceEntries() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    console.error('No driver data found');
    return;
  }
  
  showLoader();
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-service-entries&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Service entries data:", data);
      const tableBody = document.getElementById('service-entries-body');
      tableBody.innerHTML = '';
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9">No service entries found</td></tr>';
        return;
      }
      
      data.forEach(entry => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${entry.ServiceDate || ''}</td>
          <td>${entry.VehicleNumber || ''}</td>
          <td>${entry.InvoiceNumber || ''}</td>
          <td>${entry.ServiceType || ''}</td>
          <td>₹${entry.Amount || '0'}</td>
          <td>${entry.CurrentKM || ''}</td>
          <td>${entry.NextServiceDate || '-'}</td>
          <td>${entry.Workshop || ''}</td>
          <td>${entry.Remarks || '-'}</td>
          <td>
            ${entry.BillImage ? 
              `<a href="${entry.BillImage}" target="_blank" class="view-bill-link">View</a>` : 
              'No bill'}
          </td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => {
      console.error("Error loading service entries:", error);
      document.getElementById('service-entries-body').innerHTML = `
        <tr>
          <td colspan="9">Error loading data. Please try again later.</td>
        </tr>
      `;
    }).finally(() => {
      hideLoader();
    });
}

  function validateServiceForm() {
  let isValid = true;
  
  // Clear all previous error messages
  document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
  
  // Validate each field
  if (!document.getElementById('serviceVehicleName').value) {
    document.getElementById('serviceVehicleNameError').textContent = 'Please select a vehicle';
    isValid = false;
  }
  
  if (!document.getElementById('serviceVehicleNumber').value) {
    document.getElementById('serviceVehicleNumberError').textContent = 'Vehicle number is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceDate').value) {
    document.getElementById('serviceDateError').textContent = 'Please select a date';
    isValid = false;
  }
  
  if (!document.getElementById('serviceInvoiceNumber').value) {
    document.getElementById('serviceInvoiceNumberError').textContent = 'Invoice number is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceType').value) {
    document.getElementById('serviceTypeError').textContent = 'Please select service type';
    isValid = false;
  }
  
  if (!document.getElementById('serviceAmount').value) {
    document.getElementById('serviceAmountError').textContent = 'Amount is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceCurrentKm').value) {
    document.getElementById('serviceCurrentKmError').textContent = 'Current KM is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceWorkshop').value) {
    document.getElementById('serviceWorkshopError').textContent = 'Workshop name is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceWorkshopLocation').value) {
    document.getElementById('serviceWorkshopLocationError').textContent = 'Workshop location is required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceRemarks').value) {
    document.getElementById('serviceRemarksError').textContent = 'Remarks are required';
    isValid = false;
  }
  
  if (!document.getElementById('serviceBillImage').value) {
    document.getElementById('serviceBillImageError').textContent = 'Please upload a bill image';
    isValid = false;
  }
  
  return isValid;
}

// Add this function to submit service entry
async function submitServiceEntry() {
   if (validateServiceForm()) {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    showPopup('Authentication Error', 'Please login again');
    return;
  }

  // Master validation for service form
  let isValid = true;
  
  isValid &= validateRequired(document.getElementById('serviceVehicleName').value, 'serviceVehicleName');
  isValid &= validateRequired(document.getElementById('serviceDate').value, 'serviceDate');
  isValid &= validateRequired(document.getElementById('serviceInvoiceNumber').value, 'serviceInvoiceNumber');
  isValid &= validateRequired(document.getElementById('serviceType').value, 'serviceType');
  isValid &= validateNumber(document.getElementById('serviceAmount').value, 'serviceAmount');
  isValid &= validateNumber(document.getElementById('serviceCurrentKm').value, 'serviceCurrentKm');
  isValid &= validateName(document.getElementById('serviceWorkshop').value, 'serviceWorkshop');
  isValid &= validateRequired(document.getElementById('serviceWorkshopLocation').value, 'serviceWorkshopLocation');
  isValid &= validateRequired(document.getElementById('serviceRemarks').value, 'serviceRemarks');
  
  if (document.getElementById('serviceType').value === 'Service') {
    isValid &= validateRequired(document.getElementById('nextServiceDate').value, 'nextServiceDate');
  }

  if (!isValid) {
    showPopup('Validation Error', 'Please correct the highlighted fields');
    return;
  }

  // Get form values
  const serviceId = await generateServiceId();
      console.log("Generated Service ID:", serviceId); 
  const vehicleNumber = document.getElementById('serviceVehicleNumber').value;
  const vehicleName = document.getElementById('serviceVehicleName').value;
  const date = document.getElementById('serviceDate').value;
  const invoiceNumber = document.getElementById('serviceInvoiceNumber').value;
  const serviceType = document.getElementById('serviceType').value;
  const amount = document.getElementById('serviceAmount').value;
  const currentKm = document.getElementById('serviceCurrentKm').value;
  const nextServiceDate = serviceType === 'Service' ? document.getElementById('nextServiceDate').value : '-';
  const workshop = document.getElementById('serviceWorkshop').value;
  const workshopLocation = document.getElementById('serviceWorkshopLocation').value;
  const serviceRemarks = document.getElementById('serviceRemarks').value;
  const billImageFile  = document.getElementById('serviceBillImage').files[0];

  // Validate required fields
  if (!vehicleNumber || !date || !invoiceNumber || !serviceType || !amount || !currentKm || !workshop || !workshopLocation || !serviceRemarks || !billImageFile) {
    showPopup('Validation Error', 'Please fill in all required fields');
    return;
  }

  

  // Show loading state
  const submitBtn = document.querySelector('#serviceForm button[type="button"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

   // Convert image to base64
  const getBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]); // Remove the data:image/*;base64, prefix
      reader.onerror = error => reject(error);
    });
  };

   try {
    const billImageBase64 = await getBase64(billImageFile);


  // Create FormData for proper file upload
  const formData = {
    type: 'add-service-entry',
    serviceId: serviceId,
    driverId: driverData.id,
    driverName: driverData.name,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    serviceDate: date,
    invoiceNumber: invoiceNumber,
    serviceType: serviceType,
    amount: amount,
    currentKm: currentKm,
    nextServiceDate: nextServiceDate,
    workshop: workshop,
    workshopLocation: workshopLocation,
    serviceRemarks:serviceRemarks,
    billImage: billImageBase64
  };

  showLoader();
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(formData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response => response.text())
  .then(result => {
    console.log("Save as Service result:", result);
    showPopup('Success', 'Service record saved successfully!');
    document.getElementById('serviceForm').reset();
    showSection('service');
  })
  .catch(error => {
    console.error("Error saving Service:", error);
    showPopup('Error', 'Error saving Service record. Please try again.');
  }).finally(() => {
    hideLoader();
  });
      } catch (error) {
    console.error("Error converting image:", error);
    showPopup('Error', 'Error processing the bill image. Please try again.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
  }
}
}

// Add this function to generate service ID
async function generateServiceId() {
  try {
    const response = await fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-counter&type=Service`);
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    return `SVC-${String(data.counter)}`;
  } catch (error) {
    console.error("Error generating service ID:", error);
    // Fallback to timestamp if counter fails
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 5);
    return `SVC-${timestamp}-${random}`.toUpperCase();
  }
}

function showAddFuelForm() {
// Hide all sections first
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  populateVehicleDropdowns();
  // Show the form (if you're keeping it separate)
  document.getElementById('addFuelForm').style.display = 'block';
  // Scroll to form
  window.scrollTo(0, document.body.scrollHeight);
}

  function showAddServiceForm() {
// Hide all sections first
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
    populateVehicleDropdowns();
  // Show the form (if you're keeping it separate)
  document.getElementById('addServiceForm').style.display = 'block';
  // Scroll to form
  window.scrollTo(0, document.body.scrollHeight);
}

function hideAddFuelForm() {
  document.getElementById('addFuelForm').style.display = 'none';
  document.getElementById('fuelForm').reset();
  showSection('home');
}

function loadFuelEntries() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    console.error('No driver data found');
    return;
  }
  showLoader();
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-fuel-entries&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Fuel entries data:", data);
      const tableBody = document.getElementById('fuel-entries-body');
      tableBody.innerHTML = '';
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8">No fuel entries found</td></tr>';
        return;
      }
      
      data.forEach(entry => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${entry.Date || ''}</td>
          <td>${entry.VehicleNumber || ''}</td>
          <td>${entry.InvoiceNumber || ''}</td>
          <td>${entry.FuelType || ''}</td>
          <td>₹${entry.Amount || '0'}</td>
          <td>${entry.Liters || '0'}L</td>
          <td>${entry.CurrentKM || ''}</td>
          <td>
            ${entry.BillImage ? 
              `<a href="${entry.BillImage}" target="_blank" class="view-bill-link">View</a>` : 
              'No bill'}
          </td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => {
      console.error("Error loading fuel entries:", error);
      document.getElementById('fuel-entries-body').innerHTML = `
        <tr>
          <td colspan="8">Error loading data. Please try again later.</td>
        </tr>
      `;
    }).finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
}

  function populateVehicleDropdowns() {
  const vehicles = [
    { name: 'Hycross', number: 'KL02BY3091 ' },
    { name: 'Ertiga', number: 'KL23Y0927' }
  ];

  const dropdowns = [
    'vehicleName',
    'fuelVehicleName',
    'serviceVehicleName',
    'completeVehicleName'
  ];

  dropdowns.forEach(dropdownId => {
    const select = document.getElementById(dropdownId);
    if (select) {
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Add vehicle options
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.name;
        option.textContent = vehicle.name;
        select.appendChild(option);
      });
    }
  });
}


function updateVehicleNumber() {
   const vehicles = [
  { name: 'Hycross', number: 'KL02BY3091 ' },
  { name: 'Ertiga', number: 'KL23Y0927' }
];
  const selectedName = document.getElementById('vehicleName').value;
  const fuelselectedName = document.getElementById('fuelVehicleName').value;
   const serviceselectedName = document.getElementById('serviceVehicleName').value;
 const completeselectedName = document.getElementById('completeVehicleName').value;

  
  const vehicle = vehicles.find(v => v.name === selectedName);
   const fuelvehicle = vehicles.find(v => v.name === fuelselectedName);
  const servicevehicle = vehicles.find(v => v.name === serviceselectedName);
  const completeevehicle = vehicles.find(v => v.name === completeselectedName);
  
  document.getElementById('vehicleNumber').value = vehicle ? vehicle.number : '';
  document.getElementById('fuelVehicleNumber').value = fuelvehicle ? fuelvehicle.number : '';
   document.getElementById('serviceVehicleNumber').value = servicevehicle ? servicevehicle.number : '';
  document.getElementById('completeVehicleNumber').value = completeevehicle ? completeevehicle.number : '';
}



async function completeJourney(travelId) {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId= driverData.id;
  showLoader();
  populateVehicleDropdowns();
   fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=complete-journey&travelId=${encodeURIComponent(travelId)}&driverId=${encodeURIComponent(driverId)}`)
     .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
  })
  .then(data => {
      if (!data.success) {
        throw new Error(data.message || "Journey not found");
      }
      
      const journey = data.data;
      console.log("Journey details:", journey);
    
    // Populate the form fields
      document.getElementById('travelId').value = travelId;
     // Set the vehicle name in the dropdown
      const vehicleSelect = document.getElementById('completeVehicleName');
      if (vehicleSelect) {
        vehicleSelect.value = journey.VehicleName || '';
        // Trigger the onchange to update the vehicle number
        updateVehicleNumber();
      }
      //document.getElementById('completeVehicleNumber').value = journey.VehicleNumber || '';
      //document.getElementById('completeVehicleName').value = journey.VehicleName || '';
      document.getElementById('completeStartPoint').value = journey.StartPoint || '';
      document.getElementById('completeStartKm').value = journey.StartKM || '';
      
      // Format the time (assuming it comes in ISO format)
      const startTime = journey.StartTime ? new Date(journey.StartTime) : new Date();
      const formattedTime = startTime.toTimeString().substring(0, 5);
      document.getElementById('completeStartTime').value = formattedTime;
      
      document.getElementById('completePassengerCount').value = journey.PassengerCount || '';
      document.getElementById('completePassengerName').value = journey.PassengerName || '';
      document.getElementById('completePassengerPhone').value = journey.PassengerPhone || '';
       document.getElementById('completePurpose').value = journey.Purpose || '';

      // Clear the completion fields
      document.getElementById('completeEndPoint').value = '';
      document.getElementById('completeEndKm').value = '';
      document.getElementById('completeEndTime').value = '';
      
      // Show the complete journey section
      showSection('completeJourney');

  })
  .catch(error => {
    console.error("Error fetching journey details:", error);
    showPopup('Error', 'Error loading journey details. Please try again.');
    return;
  })
  .finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
}

// Function to close the modal
function closeModal() {
  const modal = document.getElementById('completeJourneyModal');
  if (modal) {
    modal.remove();
  }
}

  // Master validation function for complete journey form
function validateCompleteJourneyForm() {
  let isValid = true;
  
  // Validate all fields
  isValid &= validateRequired(document.getElementById('completeVehicleName').value, 'completeVehicleName');
  isValid &= validateRequired(document.getElementById('completeVehicleNumber').value, 'completeVehicleNumber');
  isValid &= validateRequired(document.getElementById('completeStartPoint').value, 'completeStartPoint');
  isValid &= validateNumber(document.getElementById('completeStartKm').value, 'completeStartKm');
  isValid &= validateRequired(document.getElementById('completeStartTime').value, 'completeStartTime');
  isValid &= validateNumber(document.getElementById('completePassengerCount').value, 'completePassengerCount');
  isValid &= validateName(document.getElementById('completePassengerName').value, 'completePassengerName');
  isValid &= validatePhone(document.getElementById('completePassengerPhone').value, 'completePassengerPhone');
  isValid &= validateRequired(document.getElementById('completePurpose').value, 'completePurpose');
  isValid &= validateRequired(document.getElementById('completeEndPoint').value, 'completeEndPoint');
  isValid &= validateNumber(document.getElementById('completeEndKm').value, 'completeEndKm');
  isValid &= validateRequired(document.getElementById('completeEndTime').value, 'completeEndTime');
  isValid &= validateRequired(document.getElementById('completeFuelFilled').value, 'completeFuelFilled');

  const startKm = parseFloat(document.getElementById('completeStartKm').value);
  const endKm = parseFloat(document.getElementById('completeEndKm').value);
  if (!isNaN(startKm) && !isNaN(endKm) && startKm >= endKm) {
    showError('completeEndKm', 'End KM must be greater than Start KM');
    isValid = false;
  }
  
  // If all valid, proceed with submission
  if (isValid) {
    submitCompletedJourney();
  } else {
    showPopup('Validation Error', 'Please correct the highlighted fields');
  }
}

// Function to submit the completed journey
async function submitCompletedJourney() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverId = driverData.id;
  
  // Get all form values
  const travelId = document.getElementById('travelId').value;
  const vehicleNumber = document.getElementById('completeVehicleNumber').value;
  const vehicleName = document.getElementById('completeVehicleName').value;
  const startPoint = document.getElementById('completeStartPoint').value;
  const startKm = document.getElementById('completeStartKm').value;
  const startTime = document.getElementById('completeStartTime').value;
  const passengerCount = document.getElementById('completePassengerCount').value;
  const passengerName = document.getElementById('completePassengerName').value;
  const passengerPhone = document.getElementById('completePassengerPhone').value;
  const purpose = document.getElementById('completePurpose').value;
  const endPoint = document.getElementById('completeEndPoint').value;
  const endKm = document.getElementById('completeEndKm').value;
  const endTime = document.getElementById('completeEndTime').value;
  const fuelFilled = document.getElementById('completeFuelFilled').value;
  const totalKM=endKm-startKm;

  // Validate required fields
  if (!endPoint || !endKm || !endTime || !fuelFilled) {
    showPopup('Validation Error', 'Please fill in all completion details');
    return;
  }

  // Create completion data object
  const completionData = {
    type: 'submit-complete-journey',
    travelId: travelId,
    driverId: driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone,
    purpose:purpose,
    endPoint: endPoint,
    endKm: endKm,
    endTime: endTime,
    totalKM:totalKM,
    fuelFilled:fuelFilled
    
  };

  // Show loading state
  const submitBtn = document.querySelector('#completeJourneyForm button[type="button"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

 showLoader();
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    mode: 'no-cors',
    body: JSON.stringify(completionData)
  })
  .then(response => response.text())
  .then(result => {
    console.log("Journey completion result:", result);
    showPopup('Success', 'Journey completed successfully!');
    showSection('home');
    //location.reload();
  })
  .catch(error => {
    console.error("Error completing journey:", error);
    showPopup('Error', 'Error completing journey. Please try again.');
  })
  .finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
}

  // Form validation function called when submitting
function validateJourneyForm() {
  let isValid = true;
  
  // Validate all fields
  isValid &= validateRequired(document.getElementById('vehicleName').value, 'vehicleName');
  isValid &= validateRequired(document.getElementById('vehicleNumber').value, 'vehicleNumber');
  isValid &= validateRequired(document.getElementById('startPoint').value, 'startPoint');
  isValid &= validateNumber(document.getElementById('startKm').value, 'startKm');
  isValid &= validateRequired(document.getElementById('startTime').value, 'startTime');
  isValid &= validateNumber(document.getElementById('passengerCount').value, 'passengerCount');
  isValid &= validateName(document.getElementById('passengerName').value, 'passengerName');
  isValid &= validatePhone(document.getElementById('passengerPhone').value, 'passengerPhone');
  isValid &= validateRequired(document.getElementById('purpose').value, 'purpose');
  
  // If all valid, proceed with saving
  if (isValid) {
    saveAsPending();
  } else {
    showPopup('Validation Error', 'Please fix all errors before submitting');
  }
}

// Function to save journey as pending
async function saveAsPending() {
  // Get form values
   const driverData = JSON.parse(localStorage.getItem('driverData'));
  const driverName = driverData.name;
  const driverId= driverData.id;
  const driverPhone = driverData.phoneNumber;
  const vehicleNumber = document.getElementById('vehicleNumber').value;
  const vehicleName = document.getElementById('vehicleName').value;
  const startPoint = document.getElementById('startPoint').value;
  const startKm = document.getElementById('startKm').value;
  const startTime = document.getElementById('startTime').value;
  const passengerCount = document.getElementById('passengerCount').value;
  const passengerName = document.getElementById('passengerName').value;
  const passengerPhone = document.getElementById('passengerPhone').value;
  const purpose = document.getElementById('purpose').value;

  // Validate required fields
  if (!vehicleNumber || !startPoint || !startKm || !startTime || !purpose) {
   showPopup('Validation Error', 'Please fill in all required fields');
    return;
  }

   if (!purpose || purpose.trim() === '') {
    showError('purpose', 'Purpose is required');
    return;
  } else {
    showSuccess('purpose');
  }

  // Create journey data object
  const journeyData = {
    type: 'add-pending-journey',
    driverName:driverName,
    driverPhone:driverPhone,
    driverId:driverId,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    startPoint: startPoint,
    startKm: startKm,
    startTime: startTime,
    passengerCount: passengerCount,
    passengerName: passengerName,
    passengerPhone: passengerPhone,
     purpose: purpose
  };

  showLoader();
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(journeyData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response =>response.text())
  .then(result => {
    console.log("Save as Pending result:", result);
    showPopup('Success', 'The journey has started!.');
    document.getElementById('journeyForm').reset();
    showSection('home');
   // location.reload();
  })
  .catch(error => {
    console.error("Error saving pending journey:", error);
    showPopup('Error', 'Error saving journey as pending. Please try again.');
    return;
  }).finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
}


// Function to load completed journeys when History section is shown
function loadCompletedJourneys() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    console.error('No driver data found');
    return;
  }
  showLoader();
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=history-journey&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log("Completed journeys data:", data);
      const tableBody = document.querySelector('#completedTripsTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="15">No completed journeys found</td></tr>';
        return;
      }
      
      data.forEach(journey => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${journey.TravelID || ''}</td>
          <td>${journey.Date || ''}</td>
          <td>${journey.VehicleNumber || ''}</td>
          <td>${journey.VehicleName || ''}</td>
          <td>${journey.StartPoint || ''}</td>
          <td>${journey.EndPoint || ''}</td>
          <td>${journey.StartKM || ''}</td>
          <td>${journey.EndKM || ''}</td>
           <td>${journey.TotalKMTravel || ''}</td>
          <td>${formatTime(journey.StartTime)}</td>
          <td>${formatTime(journey.EndTime)}</td>
          <td>${journey.NoPassengers || ''}</td>
          <td>${journey.PassengerName || ''}</td>
          <td>${journey.PassengerPhone || ''}</td>
          <td>${journey.Purpose || ''}</td>
          <td>${journey.FuelFilled || ''}</td>
        `;
        tableBody.appendChild(row);
      });
    })
    .catch(error => {
      console.error("Error loading completed journeys:", error);
      document.querySelector('#completedTripsTable tbody').innerHTML = `
        <tr>
          <td colspan="15">Error loading data. Please try again later.</td>
        </tr>
      `;
    }).finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });
}

function formatTime(timeString) {
  // Handle null/undefined/empty values
  if (!timeString) return '';
  
  // Convert to string if it isn't already
  timeString = String(timeString);
  
  // If it's already in HH:MM format
  if (timeString.includes(':')) return timeString;
  
  // If it's in ISO format (from spreadsheet)
  if (timeString.includes('T')) {
    try {
      const date = new Date(timeString);
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch (e) {
      return timeString; // Return original if date parsing fails
    }
  }
  
  return timeString;
}

  function validateFuelForm() {
  let isValid = true;
  
  // Clear all previous error messages
  document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
  
  // Validate each field
  if (!document.getElementById('fuelVehicleName').value) {
    document.getElementById('fuelVehicleNameError').textContent = 'Please select a vehicle';
    isValid = false;
  }
  
  if (!document.getElementById('fuelVehicleNumber').value) {
    document.getElementById('fuelVehicleNumberError').textContent = 'Vehicle number is required';
    isValid = false;
  }
  
  if (!document.getElementById('fuelDate').value) {
    document.getElementById('fuelDateError').textContent = 'Please select a date';
    isValid = false;
  }
  
  if (!document.getElementById('fuelAmount').value) {
    document.getElementById('fuelAmountError').textContent = 'Amount is required';
    isValid = false;
  } else if (isNaN(document.getElementById('fuelAmount').value) || Number(document.getElementById('fuelAmount').value) <= 0) {
    document.getElementById('fuelAmountError').textContent = 'Please enter a valid positive amount';
    isValid = false;
  }
  
  if (!document.getElementById('fuelQuantity').value) {
    document.getElementById('fuelQuantityError').textContent = 'Quantity is required';
    isValid = false;
  } else if (isNaN(document.getElementById('fuelQuantity').value) || Number(document.getElementById('fuelQuantity').value) <= 0) {
    document.getElementById('fuelQuantityError').textContent = 'Please enter a valid positive quantity';
    isValid = false;
  }
  
  if (!document.getElementById('fuelCurrentKm').value) {
    document.getElementById('fuelCurrentKmError').textContent = 'Current KM is required';
    isValid = false;
  } else if (isNaN(document.getElementById('fuelCurrentKm').value) || Number(document.getElementById('fuelCurrentKm').value) <= 0) {
    document.getElementById('fuelCurrentKmError').textContent = 'Please enter a valid positive number';
    isValid = false;
  }
  

  
  if (!document.getElementById('fuelType').value) {
    document.getElementById('fuelTypeError').textContent = 'Please select fuel type';
    isValid = false;
  }
  
  if (!document.getElementById('fuelBillImage').value) {
    document.getElementById('fuelBillImageError').textContent = 'Please upload a bill image';
    isValid = false;
  }
  
  // Remarks is optional, so no validation needed
  
  return isValid;
}
  
async function submitFuelEntry() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    showPopup('Authentication Error', 'Please login again');
    return;
  }

   if (!validateFuelForm()) {
    showPopup('Validation Error', 'Please correct the highlighted fields');
    return;
  }
  // Master validation for fuel form
  let isValid = true;
  
  // Clear previous errors
  document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
  
  // Validate all fields
  isValid &= validateRequired(document.getElementById('fuelVehicleName').value, 'fuelVehicleName');
  isValid &= validateRequired(document.getElementById('fuelVehicleNumber').value, 'fuelVehicleNumber');
  isValid &= validateRequired(document.getElementById('fuelDate').value, 'fuelDate');
  isValid &= validateNumber(document.getElementById('fuelAmount').value, 'fuelAmount');
  isValid &= validateNumber(document.getElementById('fuelQuantity').value, 'fuelQuantity');
  isValid &= validateNumber(document.getElementById('fuelCurrentKm').value, 'fuelCurrentKm');
  isValid &= validateRequired(document.getElementById('fuelType').value, 'fuelType');
  isValid &= validateRequired(document.getElementById('fuelBillImage').value, 'fuelBillImage');
  
  // Remarks is optional, so no validation needed

  if (!isValid) {
    showPopup('Validation Error', 'Please correct the highlighted fields');
    return;
  }

  // Get form values
  const fuelId = await  generateFuelId();
   console.log("Generated Fuel ID:", fuelId); 
  const vehicleNumber = document.getElementById('fuelVehicleNumber').value;
  const vehicleName = document.getElementById('fuelVehicleName').value;
  const date = document.getElementById('fuelDate').value;
  const invoiceNumber = document.getElementById('fuelInvoiceNumber').value;
  const fuelType = document.getElementById('fuelType').value;
  const amount = document.getElementById('fuelAmount').value;
  const liters = document.getElementById('fuelQuantity').value;
  const currentKm = document.getElementById('fuelCurrentKm').value;
  const billImageFile  = document.getElementById('fuelBillImage').files[0];

  // Validate required fields
  if (!vehicleNumber || !date || !invoiceNumber || !fuelType || !amount || !liters || !currentKm || !billImageFile) {
    showPopup('Validation Error', 'Please fill in all required fields');
    return;
  }

  // Show loading state
  const submitBtn = document.querySelector('#fuelForm button');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  // Convert image to base64
  const getBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]); // Remove the data:image/*;base64, prefix
      reader.onerror = error => reject(error);
    });
  };

   try {
    const billImageBase64 = await getBase64(billImageFile);

  
    // Create FormData for proper file upload
     const formData = {
    type: 'add-fuel-entry',
    fuelId:fuelId,
    driverId:driverData.id,
    driverName:driverData.name,
    vehicleNumber: vehicleNumber,
    vehicleName: vehicleName,
    date: date,
    invoiceNumber: invoiceNumber,
    fuelType: fuelType,
    amount: amount,
    liters: liters,
    currentKm: currentKm,
    billImage: billImageBase64 
  };

  showLoader();
   fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(formData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response =>response.text())
  .then(result => {
    console.log("Save as Fuel result:", result);
    showPopup('Success', 'Fuel saved successfully!');
    document.getElementById('journeyForm').reset();
    showSection('home');
    //location.reload();
  })
  .catch(error => {
    console.error("Error saving Fuel:", error);
    showPopup('Error', 'Error saving Fuel. Please try again.');
    return;
  }).finally(() => {
        hideLoader(); // Now this will only run after everything is complete
    });

     } catch (error) {
    console.error("Error converting image:", error);
    showPopup('Error', 'Error processing the bill image. Please try again.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
  }
}

  
async function generateFuelId() {
  try {
    const response = await fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-counter&type=Fuel`);
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    return `FUEL-${data.counter}`;
  } catch (error) {
    console.error("Error generating fuel ID:", error);
    // Fallback to timestamp if counter fails
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 5);
    return `FUEL-${timestamp}-${random}`.toUpperCase();
  }
}


  // Load profile data when profile section is shown
function loadProfileData() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) return;

  showLoader();
  
  // Fetch driver details from Google Sheets
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-driver-profile&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => response.json())
    .then(data => {
      if (data) {
        document.getElementById('profileDriverId').textContent = data.DriverID || '';
        document.getElementById('profileDriverName').textContent = data.DriverName || '';
        document.getElementById('profileBadge').textContent = data.UserType || '';
        
        document.getElementById('profileUsername').textContent = data.username || '';
        document.getElementById('profilePassword').textContent = '••••••••';
        document.getElementById('profilePhone').textContent = data.DriverPhone || '';
        
        // Store original values for cancel
        document.getElementById('profileUsername').setAttribute('data-original', data.username || '');
        document.getElementById('profilePassword').setAttribute('data-original', data.password || '');
        document.getElementById('profilePhone').setAttribute('data-original', data.DriverPhone || '');
      }
    })
    .catch(error => {
      console.error("Error loading profile:", error);
      showPopup('Error', 'Failed to load profile data');
    })
    .finally(() => {
      hideLoader();
    });
}

// Enable edit mode
function enableProfileEdit() {
  const username = document.getElementById('profileUsername').textContent;
  const password = document.getElementById('profilePassword').getAttribute('data-original') || '';
  const phone = document.getElementById('profilePhone').textContent;
  
  // Replace text with input fields
  document.getElementById('profileUsername').innerHTML = `<input type="text" class="detail-input" value="${username}" id="editUsername">`;
  document.getElementById('profilePassword').innerHTML = `<input type="password" class="detail-input" value="${password}" id="editPassword">`;
  document.getElementById('profilePhone').innerHTML = `<input type="tel" class="detail-input" value="${phone}" id="editPhone">`;
  
  // Show edit buttons
  document.getElementById('profileEditActions').style.display = 'flex';
}

// Cancel edit mode
function cancelProfileEdit() {
  const username = document.getElementById('profileUsername').getAttribute('data-original');
  const phone = document.getElementById('profilePhone').getAttribute('data-original');
  
  // Restore original values
  document.getElementById('profileUsername').textContent = username;
  document.getElementById('profilePassword').textContent = '••••••••';
  document.getElementById('profilePhone').textContent = phone;
  
  // Hide edit buttons
  document.getElementById('profileEditActions').style.display = 'none';
}

// Save profile changes
function saveProfileChanges() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) return;

  const newUsername = document.getElementById('editUsername').value;
  const newPassword = document.getElementById('editPassword').value;
  const newPhone = document.getElementById('editPhone').value;
  
  if (!newUsername || !newPassword || !newPhone) {
    showPopup('Validation Error', 'Please fill in all fields');
    return;
  }

  showLoader();
  
  const profileData = {
    type: 'update-driver-profile',
    driverId: driverData.id,
    username: newUsername,
    password: newPassword,
    phone: newPhone
  };

  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(profileData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response => response.text())
  .then(result => {
    console.log("Profile update result:", result);
    showPopup('Success', 'Profile updated successfully!');
    
    // Update displayed values
    document.getElementById('profileUsername').textContent = newUsername;
    document.getElementById('profilePassword').textContent = '••••••••';
    document.getElementById('profilePhone').textContent = newPhone;
    
    // Update original values
    document.getElementById('profileUsername').setAttribute('data-original', newUsername);
    document.getElementById('profilePassword').setAttribute('data-original', newPassword);
    document.getElementById('profilePhone').setAttribute('data-original', newPhone);
    
    // Hide edit buttons
    document.getElementById('profileEditActions').style.display = 'none';
    
    // Update local storage if username changed
    if (driverData.username !== newUsername) {
      driverData.username = newUsername;
      localStorage.setItem('driverData', JSON.stringify(driverData));
    }
  })
  .catch(error => {
    console.error("Error updating profile:", error);
    showPopup('Error', 'Failed to update profile');
  })
  .finally(() => {
    hideLoader();
  });
}

  // Validation functions (similar to your index.html but with some additions)
function validateRequired(value, fieldId) {
  if (!value || value.trim() === '') {
    showError(fieldId, 'This field is required');
    return false;
  }
  showSuccess(fieldId);
  return true;
}

function validateName(name, fieldId) {
  const nameRegex = /^[A-Za-z\s]+$/; // Allows spaces between names
  
  if (!validateRequired(name, fieldId)) {
    return false;
  }
  
  if (!nameRegex.test(name)) {
    showError(fieldId, 'Only alphabets and spaces are allowed');
    return false;
  }
  
  showSuccess(fieldId);
  return true;
}

function validateNumber(number, fieldId) {
  if (!validateRequired(number, fieldId)) {
    return false;
  }
  
  if (isNaN(number) || number <= 0) {
    showError(fieldId, 'Please enter a valid positive number');
    return false;
  }
  
  showSuccess(fieldId);
  return true;
}

function validatePhone(phone, fieldId) {
  const phoneRegex = /^[0-9]{10}$/;
  
  if (!validateRequired(phone, fieldId)) {
    return false;
  }
  
  if (!phoneRegex.test(phone)) {
    showError(fieldId, 'Please enter a valid 10-digit phone number');
    return false;
  }
  
  showSuccess(fieldId);
  return true;
}

// Show error/success messages (same as in index.html)
function showError(fieldId, message) {
  const input = document.getElementById(fieldId);
  const errorElement = document.getElementById(`${fieldId}Error`);
  
  input.classList.remove('valid');
  input.classList.add('invalid');

  errorElement.textContent = message;
  errorElement.style.display = 'block';
 
}

function showSuccess(fieldId) {
  const input = document.getElementById(fieldId);
  const errorElement = document.getElementById(`${fieldId}Error`);
  
  input.classList.remove('invalid');
  input.classList.add('valid');
  errorElement.style.display = 'none';
}


// Add this function to check and start the timer
function checkGuestTimer() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData || driverData.userType !== 'Guest') {
    return; // Only show for Guest drivers
  }

  showLoader();
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-guest-timer&driverId=${encodeURIComponent(driverData.id)}`)
    .then(response => response.json())
    .then(data => {
      if (data.activeTimestamp) {
        //startCountdownTimer(data.activeTimestamp);
        const timer = new CountdownTimer(data.activeTimestamp);
        document.getElementById('guestTimerContainer').style.display = 'block';
      }
    })
    .catch(error => {
      console.error("Error checking guest timer:", error);
    })
    .finally(() => {
      hideLoader();
    });
}

class CountdownTimer {
  constructor(activeTimestamp) {
    // User was created at activeTimestamp, can be active for 24 hours from THEN
    this.userCreationTime = new Date(activeTimestamp).getTime();
    this.expiryTime = this.userCreationTime + (24 * 60 * 60 * 1000);
    this.timerInterval = null;
    this.initializeTimer();
  }

  initializeTimer() {
    this.updateTimer();
    this.timerInterval = setInterval(() => this.updateTimer(), 1000);
  }

  updateTimer() {
    const now = new Date().getTime();
    const remainingTime = this.expiryTime - now;
    
    if (remainingTime <= 0) {
      this.clearTimer();
      document.getElementById('guestTimerContainer').innerHTML = `
        <div class="timer-expired">Guest access expired</div>
      `;
      return;
    }
    
    const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
    
    this.updateTimerDisplay(hours, minutes, seconds);
  }

  clearTimer() {
    if (this.timerInterval) {
      clearInterval(this.timerInterval);
      this.timerInterval = null;
    }
  }

  updateTimerDisplay(hours, minutes, seconds) {
    const formattedHours = String(Math.floor(hours)).padStart(2, '0');
    const formattedMinutes = String(minutes).padStart(2, '0');
    const formattedSeconds = String(seconds).padStart(2, '0');
    
   // Update hour digits
    document.getElementById('hour_1').textContent = formattedHours[0];
    document.getElementById('hour_0').textContent = formattedHours[1];
    
    // Update minute digits
    document.getElementById('min_1').textContent = formattedMinutes[0];
    document.getElementById('min_0').textContent = formattedMinutes[1];
    
    // Update second digits
    document.getElementById('sec_1').textContent = formattedSeconds[0];
    document.getElementById('sec_0').textContent = formattedSeconds[1];
    
    // Add animations
    this.animateTimerDigit('hour_1', formattedHours[0]);
    this.animateTimerDigit('hour_0', formattedHours[1]);
    this.animateTimerDigit('min_1', formattedMinutes[0]);
    this.animateTimerDigit('min_0', formattedMinutes[1]);
    this.animateTimerDigit('sec_1', formattedSeconds[0]);
    this.animateTimerDigit('sec_0', formattedSeconds[1]);
    
  }

  animateTimerDigit(elementId, newValue) {
    const element = document.getElementById(elementId);
    element.classList.add('animate');
    setTimeout(() => {
      element.textContent = newValue;
      element.classList.remove('animate');
    }, 100);
  }
}

function setupAutocomplete(inputId, suggestionsId) {
  const input = document.getElementById(inputId);
  const suggestions = document.getElementById(suggestionsId);

  input.addEventListener("input", () => {
    const query = input.value.trim();
    if (query.length < 3) {
      suggestions.innerHTML = "";
      return;
    }

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=IN`)
      .then(response => response.json())
      .then(data => {
        suggestions.innerHTML = "";
        const keralaResults = data.filter(place => 
      place.address.state === "Kerala"
    );

        keralaResults.forEach(place => {
          const div = document.createElement("div");
          div.classList.add("suggestion-item");
          div.textContent = place.display_name;
          div.addEventListener("click", () => {
            input.value = place.display_name;
            suggestions.innerHTML = "";
            console.log(`${inputId} selected:`, place);
            // You can also use place.lat and place.lon if needed
          });
          suggestions.appendChild(div);
        });
      });
  });

    // Hide suggestions when clicking outside
  document.addEventListener("click", (e) => {
    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.innerHTML = "";
    }
  });
}


// Usage:
// const timer = new CountdownTimer(activeTimestamp);
  
</script>


  <!-- Custom Popup Structure -->
<div class="popup-overlay" id="customPopup">
  <div class="popup-container">
    <button class="popup-close" id="popupClose">&times;</button>
    <h3 class="popup-title" id="popupTitle">Message</h3>
    <div class="popup-message" id="popupMessage"></div>
    <div class="popup-buttons">
      <button class="popup-button" id="popupOk">OK</button>
    </div>
  </div>
</div>

  <footer class="app-footer">
  <p>© 2025 Travel Log App | Developed by <strong>R Sukrudha Ram</strong></p>
</footer>
 
  
</body>
</html>
