<!DOCTYPE html>
<html>
<head>
  <title>Driver Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>


<!-- Then your app.js -->
<script src="./js/app.js"></script>

</head>
<body>
  <div class="navbar">
    <div class="user-info">
      <div class="avatar"></div>
      <span id="driverName">Hello, John Doe</span>
    </div>
    <div class="menu">
      <button onclick="showSection('home')">Home</button>
      <button onclick="showSection('addJourney')">Add Journey</button>
      <button onclick="showSection('history')">History</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="home" class="section active">
    <h2>Pending Journeys</h2>
    <table id="pendingTable">
      <thead>
        <tr>
          <th>Vehicle</th><th>Start Point</th><th>Start KM</th><th>Start Time</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="journeys-table-body">
        <!-- Data will be inserted here by JavaScript -->
    </tbody>
    </table>
  </div>

  <div id="addJourney" class="section">
    <h2>Start New Journey</h2>
    <form id="journeyForm">
      <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required>
      <input type="text" id="vehicleName" placeholder="Vehicle Name" required>
      <input type="text" id="startPoint" placeholder="Starting Point" required>
      <input type="number" id="startKm" placeholder="Starting KM" required>
      <input type="time" id="startTime" required>
      <input type="number" id="passengerCount" placeholder="No. of Passengers" required>
      <input type="text" id="passengerName" placeholder="One Passenger Name" required>
      <input type="tel" id="passengerPhone" placeholder="Passenger Phone (10-digits)" pattern="[0-9]{10}" required>
      <button type="submit">Start Journey</button>
      <button type="button" onclick="saveAsPending()">Save as Pending</button>
    </form>
  </div>

  <div id="history" class="section">
    <h2>Journey History</h2>
   <!-- Pending Trips Table (for Home Page) -->
<table id="pendingTripsTable">
  <thead>
    <tr>
      <th>Travel ID</th>
      <th>Date</th>
      <th>Vehicle Number</th>
      <th>Starting Point</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Completed Trips Table (for History Page) -->
<table id="completedTripsTable">
  <thead>
    <tr>
      <th>Travel ID</th>
      <th>Date</th>
      <th>Vehicle Number</th>
      <th>Starting Point</th>
      <th>Ending Point</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  </div>

  <script src="js/app.js"></script>
  
<script>
// Function to fetch pending journeys
async function fetchPendingJourneys() {
    try {
        // Replace with your deployed Apps Script web app URL
        const scriptUrl = 'https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec';
        
        const response = await fetch(`${scriptUrl}?action=pending-journeys`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to fetch data');
        }
        
        return data;
    } catch (error) {
        console.error('Error fetching pending journeys:', error);
        return [];
    }
}

// Function to populate the table
function populateTable(journeys) {
    const tableBody = document.getElementById('journeys-table-body');
    tableBody.innerHTML = ''; // Clear existing rows
    
    journeys.forEach(journey => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${journey['VehicleNumber'] || ''}</td>
            <td>${journey['StartPoint'] || ''}</td>
            <td>${journey['StartKM'] || ''}</td>
            <td>${journey['StartTime'] || ''}</td>
            <td>
                <button class="btn btn-primary complete-btn" data-id="${journey['TravelID'] || ''}">
                    Complete
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Add event listeners to complete buttons
    document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const travelId = this.getAttribute('data-id');
            completeJourney(travelId);
        });
    });
}

// Function to mark journey as complete
async function completeJourney(travelId) {
    try {
        // You'll need to implement this in your Apps Script
        const scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
        const response = await fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify({
                type: "complete-journey",
                travelId: travelId
            })
        });
        
        const result = await response.text();
        console.log(result);
        
        // Refresh the table after completion
        loadPendingJourneys();
    } catch (error) {
        console.error('Error completing journey:', error);
    }
}

// Main function to load and display pending journeys
async function loadPendingJourneys() {
    const journeys = await fetchPendingJourneys();
    populateTable(journeys);
}

// Call the function when the page loads
document.addEventListener('DOMContentLoaded', loadPendingJourneys);
</script>
</body>
</html>
