

<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" href="./img/travelicon.png">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="./js/app.js"></script>
  <style>
#driverName {
    color: black !important;
}
    /* ===== Base Styles ===== */
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
  color: #333;
  display: flex;
  min-height: 100vh;
}

/* ===== Loader Styles ===== */
.loader-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

.loader {
  border: 5px solid #f3f3f3;
  border-top: 5px solid #3498db;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== Navigation Rail ===== */
.nav-rail {
  width: 72px;
  height: 100vh;
  background-color: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: width 0.3s ease;
  position: fixed;
  z-index: 100;
  overflow: hidden;
}

.nav-rail.expanded {
  width: 280px;
}

.nav-header {
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #eee;
}

.user-info {
  display: flex;
  align-items: center;
  white-space: nowrap;
  overflow: hidden;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #e0e0e0;
  margin-right: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #555;
  font-weight: bold;
}

.nav-toggle {
  background: none;
  border: none;
  cursor: pointer;
  color: #555;
  padding: 8px;
  border-radius: 50%;
}

.nav-toggle:hover {
  background-color: #f0f0f0;
}

.nav-menu {
  padding: 8px 0;
}

.nav-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.nav-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  text-decoration: none;
  color: #555;
  white-space: nowrap;
  transition: background-color 0.2s;
}

.nav-item:hover {
  background-color: #f0f0f0;
}

.nav-item.active {
  color: #1976D2;
  background-color: #E3F2FD;
}

.nav-item .material-symbols-outlined,
.nav-item .material-icons {
  margin-right: 16px;
  font-size: 24px;
}

.nav-text {
  opacity: 0;
  transition: opacity 0.3s;
}

.nav-rail.expanded .nav-text {
  opacity: 1;
}

.nav-footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  border-top: 1px solid #eee;
}

/* ===== Main Content ===== */
.main-content {
  margin-left: 72px;
  padding: 24px;
  flex-grow: 1;
  transition: margin-left 0.3s ease;
   padding-bottom: 80px; /* Add space for footer */
}

.nav-rail.expanded + .main-content {
  margin-left: 280px;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

/* ===== Stats Cards ===== */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background-color: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.stat-card .material-symbols-outlined {
  font-size: 48px;
  color: #1976D2;
  margin-bottom: 10px;
}

.stat-card h3 {
  margin: 10px 0;
  font-size: 28px;
  color: #333;
}

.stat-card p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

/* ===== Tables ===== */
.table-wrapper {
  overflow-x: auto;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
}

.fl-table {
  border-collapse: collapse;
  width: 100%;
  min-width: 600px;
}

.fl-table thead th {
  background-color: #1976D2;
  color: white;
  padding: 12px 15px;
  text-align: left;
  font-weight: 500;
}

.fl-table tbody td {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  vertical-align: middle;
}

.fl-table tbody tr:hover {
  background-color: #f5f5f5;
}

.fl-table tbody tr:last-child td {
  border-bottom: none;
}

/* ===== Buttons ===== */
.btn {
  background-color: #1976D2;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.3s;
}

.btn:hover {
  background-color: #1565C0;
}

.cancel-btn {
  background-color: #f5f5f5;
  color: #333;
  margin-left: 10px;
}

.cancel-btn:hover {
  background-color: #e0e0e0;
}

.view-bill-link {
  color: #1976D2;
  text-decoration: none;
}

.view-bill-link:hover {
  text-decoration: underline;
}

/* ===== Request Details ===== */
.request-details {
  background-color: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
}

.request-details p {
  margin: 5px 0;
}

.request-details strong {
  display: inline-block;
  width: 155px;
  color: #555;
}

.approval-form {
  margin-top: 20px;
  padding: 15px;
  background-color: #e8f5e9;
  border-radius: 8px;
}

.approval-form h3 {
  margin-top: 0;
  color: #2E7D32;
}

/* ===== Form Elements ===== */
.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: inherit;
  font-size: 14px;
}

.form-group textarea {
  min-height: 80px;
  resize: vertical;
}

/* ===== Profile Section ===== */
.profile-container {
  background-color: #fff;
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  max-width: 600px;
  margin: 0 auto;
}

.profile-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 20px;
  color: #555;
  font-size: 40px;
}

.profile-details {
  border-top: 1px solid #eee;
  padding-top: 20px;
}

.detail-row {
  display: flex;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f5f5f5;
}

.detail-label {
  font-weight: 500;
  color: #555;
  min-width: 120px;
}

.detail-value {
  color: #333;
}

/* ===== Badges ===== */
.admin-badge {
  background-color: #ff5722;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  margin-left: 8px;
}

.status-badge {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  display: inline-block;
}

.status-pending {
  background-color: #FFB343;
  color: #000;
}

.status-approved, .status-completed {
  background-color: #4CAF50;
  color: white;
}

.status-rejected {
  background-color: #f44336;
  color: white;
}

.status-hold {
  background-color: #2196F3;
  color: white;
}

/* ===== Popup ===== */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.popup-overlay.active {
  opacity: 1;
  visibility: visible;
}

.popup-container {
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  width: 90%;
  max-width: 400px;
  padding: 20px;
  position: relative;
}

.popup-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #666;
}

.popup-title {
  margin-top: 0;
  color: #1976D2;
}

.popup-message {
  margin: 20px 0;
  color: #333;
}

.popup-buttons {
  display: flex;
  justify-content: flex-end;
}

.popup-button {
  background-color: #1976D2;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.popup-button:hover {
  background-color: #1565C0;
}

/* ===== Footer ===== */
.app-footer {
  text-align: center;
  padding: 20px;
  color: #666;
  font-size: 14px;
  margin-top: 40px;
}

.app-footer strong {
  color: #333;
}

/* ===== Responsive Styles ===== */
@media (max-width: 768px) {
  .nav-rail {
    width: 0;
    position: fixed;
    z-index: 1000;
    height: 100%;
  }
  
  .nav-rail.expanded {
    width: 280px;
  }
  
  .main-content {
    margin-left: 0;
  }
  
  .nav-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 900;
  }
  
  .nav-rail.expanded + .nav-overlay {
    display: block;
  }
  
  .stats-container {
    grid-template-columns: 1fr;
  }
}

/* ===== Material Icons Adjustments ===== */
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}
    /* Add admin-specific styles here */
    .admin-badge {
      background-color: #ff5722;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .status-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-pending {
      background-color: #FFB343;
      color: #000;
    }
    
    .status-approved {
      background-color: #4CAF50;
      color: white;
    }
    
    .status-rejected {
      background-color: #f44336;
      color: white;
    }
    
    .status-hold {
      background-color: #2196F3;
      color: white;
    }
    
    .request-details {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .request-details p {
      margin: 5px 0;
    }
    
    .request-details strong {
      display: inline-block;
      width: 155px;
    }
    
    .approval-form {
      margin-top: 20px;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 8px;
    }

    /* ===== Footer Fix ===== */
.app-footer {
  position: fixed;
  bottom: 0;
  left: -1rem;
  right: 0;
  text-align: center;
  padding: 10px;
  color: #666;
  font-size: 12px;
  background-color: #f5f5f5;
  border-top: 1px solid #ddd;
  z-index: 10;
  transition: left 0.3s ease;
}

.nav-rail.expanded + .main-content + .app-footer {
  left: 280px;
}

@media (max-width: 768px) {
  .app-footer {
    left: 0;
  }
  
  .nav-rail.expanded + .main-content + .app-footer {
    left: 0;
  }
}

    @media (max-width: 768px) {
  .nav-rail {
    width: 0;
    position: fixed;
    z-index: 1000;
    height: 100%;
    top: 0;
    left: 0;
    transition: width 0.3s ease;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
  }
  
  .nav-rail.expanded {
    width: 280px;
  }
  
  .main-content {
    margin-left: 0;
    padding-bottom: 60px; /* Add space for footer */
  }
  
  .nav-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 900;
  }
  
  .nav-rail.expanded + .nav-overlay {
    display: block;
  }
  
  /* Add a mobile menu toggle button */
  .mobile-menu-toggle {
    display: block;
    position: fixed;
    top: 10px;
    left: 10px;
    background: #1976D2;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    z-index: 800;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }
  
  /* Hide desktop toggle in mobile */
  .nav-toggle {
    display: none;
  }
    .fl-table{
      min-width:0px !important;
    }
}

    .admin-avatar{
      display:block;
    }

    /* Add this to your existing CSS */
.stat-card {
  position: relative; /* Add this to make the badge position relative to the card */
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #ff5722;
  color: white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 25px;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}
    
  </style>
</head>
<body>
  <button class="mobile-menu-toggle" id="mobileMenuToggle" style="display: none;">
  <span class="material-symbols-outlined" style="margin-left: -0.75rem;">menu</span>
</button>
  
<div class="loader-container" id="loader">
    <div class="loader"></div>
</div>

<div class="nav-rail">
  <div class="nav-header">
    <div class="user-info">
      <div class="avatar">
        <span class="material-symbols-outlined admin-avatar">admin_panel_settings</span>
      </div>
      <span id="driverName"></span>
    </div>
    <button class="nav-toggle" id="navToggle">
      <span class="material-symbols-outlined">menu</span>
    </button>
  </div>
  
  <nav class="nav-menu">
    <ul>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('home')" class="nav-item active">
          <span class="material-symbols-outlined">home</span>
          <span class="nav-text">Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('journeys')" class="nav-item">
          <span class="material-symbols-outlined">directions_car</span>
          <span class="nav-text">Journeys</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('fuel')" class="nav-item">
          <span class="material-symbols-outlined">local_gas_station</span>
          <span class="nav-text">Fuel</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('service')" class="nav-item">
          <span class="material-symbols-outlined">build</span>
          <span class="nav-text">Services</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('requests')" class="nav-item">
          <span class="material-symbols-outlined">assignment</span>
          <span class="nav-text">Requests</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="event.preventDefault(); showSection('profile')" class="nav-item">
          <span class="material-symbols-outlined">account_circle</span>
          <span class="nav-text">Profile</span>
        </a>
      </li>
    </ul>

    <div class="nav-footer">
      <a href="#" onclick="logout()" class="nav-item">
        <span class="material-symbols-outlined">logout</span>
        <span class="nav-text">Logout</span>
      </a>
    </div>
  </nav>
</div>

<div class="nav-overlay" id="navOverlay"></div>
<div class="main-content">

  <div id="home" class="section active">
    <h2>Admin Dashboard</h2>
    <div class="stats-container">
      <div class="stat-card">
        <a href="#" onclick="event.preventDefault(); showSection('journeys')">
          <span class="material-symbols-outlined">directions_car</span>
        <h3 id="totalJourneys">0</h3>
        <p>Total Journeys</p>
        </a>
      </div>
      <div class="stat-card">
        <a href="#" onclick="event.preventDefault(); showSection('fuel')">
        <span class="material-symbols-outlined">local_gas_station</span>
        <h3 id="totalFuel">0</h3>
        <p>Fuel Entries</p>
        </a>
      </div>
      <div class="stat-card">
         <a href="#" onclick="event.preventDefault(); showSection('service')" >
        <span class="material-symbols-outlined">build</span>
        <h3 id="totalServices">0</h3>
        <p>Service Records</p>
        </a>
      </div>
      <div class="stat-card">
         <a href="#" onclick="event.preventDefault(); showSection('requests')">
        <span class="material-symbols-outlined">assignment</span>
        <h3 id="pendingRequests">0</h3>
        <p>Pending Requests</p>
        <div id="pendingRequestsBadge" class="notification-badge" style="display: none;"></div>
        </a>
      </div>
    </div>
    
  
  </div>
  
  <div id="journeys" class="section">
    <h2>All Journeys</h2>
    <div class="table-wrapper">
      <table class="fl-table" id="allJourneysTable">
        <thead>
          <tr>
            <th>Travel ID</th>
            <th>Date</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Start Point</th>
            <th>End Point</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="fuel" class="section">
    <h2>All Fuel Entries</h2>
    <div class="table-wrapper">
      <table class="fl-table" id="allFuelTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Invoice No</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Liters</th>
            <th>KM Reading</th>
            <th>Bill</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="service" class="section">
    <h2>All Service Records</h2>
    <div class="table-wrapper">
      <table class="fl-table" id="allServiceTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Invoice No</th>
            <th>Type</th>
            <th>Amount</th>
            <th>KM Reading</th>
            <th>Next Service</th>
            <th>Workshop</th>
            <th>Bill</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="requests" class="section">
    <h2>All Requests</h2>
    <div class="table-wrapper">
      <table class="fl-table" id="allRequestsTable">
        <thead>
          <tr>
            <th>Request ID</th>
            <th>Date</th>
            <th>Requester Name</th>
            <th>Requester Phone</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="requestDetails" class="section">
    <h2>Request Details</h2>
    <div id="requestDetailsContent"></div>
    
    <div class="approval-form" id="approvalForm">
      <h3>Update Request Status</h3>
      <form id="requestApprovalForm">
        <input type="hidden" id="requestId">
        
        <div class="form-group">
          <label for="approvalStatus">Status:</label>
          <select id="approvalStatus" required>
            <option value="">Select Status</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Hold">Hold</option>
          </select>
        </div>
        
        <div id="driverSelection" style="display:none;">
          <div class="form-group">
            <label for="assignedDriver">Assign Driver:</label>
            <select id="assignedDriver">
              <option value="">Select Driver</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="approvalRemarks">Remarks:</label>
          <textarea id="approvalRemarks" rows="3"></textarea>
        </div>
        
        <button type="button" onclick="submitRequestApproval()">Update Request</button>
        <button type="button" class="cancel-btn" onclick="showSection('requests')">Cancel</button>
      </form>
    </div>
  </div>

  <div id="profile" class="section">
    <h2>Admin Profile</h2>
    <div class="profile-container">
      <div class="profile-header">
        <h3 id="profileAdminName"></h3>
        <span class="admin-badge">ADMIN</span>
        <div class="profile-avatar">
          <span class="material-symbols-outlined">admin_panel_settings</span>
        </div>
        
      </div>
      
      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label">Admin ID:</span>
          <span class="detail-value" id="profileAdminId"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Username:</span>
          <span class="detail-value" id="profileUsername"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phone:</span>
          <span class="detail-value" id="profilePhone"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

  // Add mobile menu toggle button
function addMobileMenuToggle() {
  if (window.innerWidth <= 768) {
    // Check if toggle button already exists
    if (!document.getElementById('mobileMenuToggle')) {
      const toggleBtn = document.createElement('button');
      toggleBtn.id = 'mobileMenuToggle';
      toggleBtn.className = 'mobile-menu-toggle';
      toggleBtn.innerHTML = '<span class="material-symbols-outlined">menu</span>';
      toggleBtn.onclick = function() {
        document.querySelector('.nav-rail').classList.toggle('expanded');
      };
      document.body.appendChild(toggleBtn);
    }
  } else {
    // Remove if exists when not in mobile view
    const toggleBtn = document.getElementById('mobileMenuToggle');
    if (toggleBtn) {
      toggleBtn.remove();
    }
  }
}

// Call this on load and resize
window.addEventListener('load', addMobileMenuToggle);
window.addEventListener('resize', addMobileMenuToggle);
  
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
    
  if (driverData) {
    // Display admin name
    const adminNameElement = document.getElementById('driverName');
    if (adminNameElement) {
      adminNameElement.textContent = driverData.name;
      
    }
    
    // Load all data
    loadDashboardStats();
    loadAllJourneys();
    loadAllFuelEntries();
    loadAllServiceEntries();
    loadAllRequests();
    loadDriversForAssignment();
  } else {
    // If no admin data found, redirect to login
    window.location.href = './index.html';
  }
  
  // Initialize navigation
  initNavigation();
});

// Navigation functions
function initNavigation() {
  document.getElementById('navToggle').addEventListener('click', function() {
    document.querySelector('.nav-rail').classList.toggle('expanded');
  });

  document.getElementById('navOverlay').addEventListener('click', function() {
    document.querySelector('.nav-rail').classList.remove('expanded');
  });

  document.addEventListener('click', function(event) {
    const rail = document.querySelector('.nav-rail');
    const isClickInsideRail = rail.contains(event.target);
    const isClickOnToggle = event.target.closest('#navToggle');
    
    if (!isClickInsideRail && !isClickOnToggle && window.innerWidth > 768) {
      rail.classList.remove('expanded');
    }
  });
}

function showSection(sectionId) {
  // Hide all sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Show the selected section
  document.getElementById(sectionId).classList.add('active');
  
  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Find and activate the corresponding nav item
  const navItems = document.querySelectorAll('.nav-item');
  switch(sectionId) {
    case 'home':
      navItems[0].classList.add('active');
      break;
    case 'journeys':
      navItems[1].classList.add('active');
      break;
    case 'fuel':
      navItems[2].classList.add('active');
      break;
    case 'service':
      navItems[3].classList.add('active');
      break;
    case 'requests':
      navItems[4].classList.add('active');
      break;
    case 'profile':
      navItems[5].classList.add('active');
     loadProfileData();
      break;
  }
}

// Dashboard stats
function loadDashboardStats() {
  showLoader();
  
  // Fetch all data counts
  Promise.all([
    fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-journey-count").then(res => res.json()),
    fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-fuel-count").then(res => res.json()),
    fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-service-count").then(res => res.json()),
    fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-pending-request-count").then(res => res.json())
  ])
  .then(([journeys, fuel, services, requests]) => {
    document.getElementById('totalJourneys').textContent = journeys.count || 0;
    document.getElementById('totalFuel').textContent = fuel.count || 0;
    document.getElementById('totalServices').textContent = services.count || 0;
    document.getElementById('pendingRequests').textContent = requests.count || 0;

    // Update notification badge
    const badge = document.getElementById('pendingRequestsBadge');
    if (requests.count > 0) {
      badge.style.display = 'flex';
      badge.textContent = requests.count;
    } else {
      badge.style.display = 'none';
    }
   
  })
  .catch(error => {
    console.error("Error loading dashboard stats:", error);
    showPopup('Error', 'Failed to load dashboard data');
  })
  .finally(() => {
    hideLoader();
  });
}

// Load all journeys
function loadAllJourneys() {
  showLoader();
  
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-all-journeys")
    .then(response => response.json())
    .then(data => {
      const tableBody = document.querySelector('#allJourneysTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length > 0) {
        data.forEach(journey => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${journey.TravelID || ''}</td>
            <td>${journey.Date || ''}</td>
            <td>${journey.DriverName || ''}</td>
            <td>${journey.VehicleNumber || ''}</td>
            <td>${journey.StartPoint || ''}</td>
            <td>${journey.EndPoint || ''}</td>
            <td>${getStatusBadge(journey.Status || '')}</td>
            <td><button class="btn" onclick="viewJourneyDetails('${journey.TravelID || ''}')">View</button></td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="8">No journeys found</td></tr>';
      }
    })
    .catch(error => {
      console.error("Error loading journeys:", error);
      showPopup('Error', 'Failed to load journeys');
    })
    .finally(() => {
      hideLoader();
    });
}

// Load all fuel entries
function loadAllFuelEntries() {
  showLoader();
  
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-all-fuel-entries")
    .then(response => response.json())
    .then(data => {
      const tableBody = document.querySelector('#allFuelTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length > 0) {
        data.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.Date || ''}</td>
            <td>${entry.DriverName || ''}</td>
            <td>${entry.VehicleNumber || ''}</td>
            <td>${entry.InvoiceNumber || ''}</td>
            <td>${entry.FuelType || ''}</td>
            <td>₹${entry.Amount || '0'}</td>
            <td>${entry.Liters || '0'}L</td>
            <td>${entry.CurrentKM || ''}</td>
            <td>
              ${entry.BillImage ? 
                `<a href="${entry.BillImage}" target="_blank" class="view-bill-link">View</a>` : 
                'No bill'}
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="9">No fuel entries found</td></tr>';
      }
    })
    .catch(error => {
      console.error("Error loading fuel entries:", error);
      showPopup('Error', 'Failed to load fuel entries');
    })
    .finally(() => {
      hideLoader();
    });
}

// Load all service entries
function loadAllServiceEntries() {
  showLoader();
  
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-all-service-entries")
    .then(response => response.json())
    .then(data => {
      const tableBody = document.querySelector('#allServiceTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length > 0) {
        data.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.ServiceDate || ''}</td>
            <td>${entry.DriverName || ''}</td>
            <td>${entry.VehicleNumber || ''}</td>
            <td>${entry.InvoiceNumber || ''}</td>
            <td>${entry.ServiceType || ''}</td>
            <td>₹${entry.Amount || '0'}</td>
            <td>${entry.CurrentKM || ''}</td>
            <td>${entry.NextServiceDate || '-'}</td>
            <td>${entry.Workshop || ''}</td>
            <td>
              ${entry.BillImage ? 
                `<a href="${entry.BillImage}" target="_blank" class="view-bill-link">View</a>` : 
                'No bill'}
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="10">No service entries found</td></tr>';
      }
    })
    .catch(error => {
      console.error("Error loading service entries:", error);
      showPopup('Error', 'Failed to load service entries');
    })
    .finally(() => {
      hideLoader();
    });
}

// Load all requests
function loadAllRequests() {
  showLoader();
  
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-all-requests")
    .then(response => response.json())
    .then(data => {
      const tableBody = document.querySelector('#allRequestsTable tbody');
      tableBody.innerHTML = '';
      
      if (data.length > 0) {
        data.forEach(request => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${request.RequestID || ''}</td>
            <td>${request.RequestDate || ''}</td>
            <td>${request.RequesterName || ''}</td>
            <td>${request.RequesterPhone || ''}</td>
            <td>${getStatusBadge(request.Status || 'Pending')}</td>
            <td><button class="btn" onclick="viewRequestDetails('${request.RequestID || ''}')">View</button></td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="6">No requests found</td></tr>';
      }

      // Update pending requests count in dashboard
      const pendingCount = data.filter(req => req.Status === 'Pending').length;
      document.getElementById('pendingRequests').textContent = pendingCount;
      
      const badge = document.getElementById('pendingRequestsBadge');
      if (pendingCount > 0) {
        badge.style.display = 'flex';
        badge.textContent = pendingCount;
      } else {
        badge.style.display = 'none';
      }
      
    })
    .catch(error => {
      console.error("Error loading requests:", error);
      showPopup('Error', 'Failed to load requests');
    })
    .finally(() => {
      hideLoader();
    });
}

// Load drivers for assignment dropdown
function loadDriversForAssignment() {
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-all-drivers")
    .then(response => response.json())
    .then(data => {
      const driverDropdown = document.getElementById('assignedDriver');
      driverDropdown.innerHTML = '<option value="">Select Driver</option>';
      
      if (data.length > 0) {
        data.forEach(driver => {
          const option = document.createElement('option');
          option.value = driver.DriverID;
          option.textContent = `${driver.DriverName} (${driver.DriverPhone})`;
          driverDropdown.appendChild(option);
        });
      }
    })
    .catch(error => {
      console.error("Error loading drivers:", error);
    });
}

// View request details
function viewRequestDetails(requestId) {
  showLoader();
  
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-request-details&requestId=${encodeURIComponent(requestId)}`)
    .then(response => response.json())
    .then(data => {
      if (data) {
        document.getElementById('requestId').value = requestId;
        if(${data.Status} == "Approved"){
           document.getElementById('approvalForm').style.display = 'none';
        }
        else{
             document.getElementById('approvalForm').style.display = 'block';
        }
        // Display request details
        const detailsContent = document.getElementById('requestDetailsContent');
        detailsContent.innerHTML = `
          <div class="request-details">
            <p><strong>Request ID:</strong> ${data.RequestID || ''}</p>
            <p><strong>Date:</strong> ${data.RequestDate || ''}</p>
            <p><strong>Requester Name:</strong> ${data.RequesterName || ''} (${data.RequesterName || ''})</p>
            <p><strong>Requester Phone:</strong> ${data.RequesterPhone || ''}</p>
            <p><strong>Status:</strong> ${getStatusBadge(data.Status || 'Pending')}</p>
            <p><strong>No of Passengers:</strong> ${data.NoofPassengers || ''}</p>
            <p><strong>Purpose:</strong> ${data.Purpose || ''}</p>
            <p><strong>StartingPoint:</strong> ${data.StartingPoint || ''}</p>
            <p><strong>StaringTime:</strong> ${data.StaringTime || ''}</p>
            <p><strong>Destination:</strong> ${data.Destination || ''}</p>
            ${data.ApprovedBy ? `<p><strong>Approved By:</strong> ${data.ApprovedBy || ''}</p>` : ''}
            ${data.Remarks ? `<p><strong>Remarks:</strong> ${data.Remarks || ''}</p>` : ''}
            ${data.DriverName ? `<p><strong>Assigned Driver:</strong> ${data.DriverName || ''}</p>` : ''}
          </div>
        `;
        
        // Set current status in dropdown
        document.getElementById('approvalStatus').value = data.Status || 'Pending';
        
        // Show driver selection if status is Approved
        if (data.Status === 'Approved') {
          document.getElementById('driverSelection').style.display = 'block';
          document.getElementById('assignedDriver').value = data.DriverID || '';
        }
        
        // Set remarks
        document.getElementById('approvalRemarks').value = data.Remarks || '';
        
        showSection('requestDetails');
      } else {
        showPopup('Error', 'Request details not found');
      }
    })
    .catch(error => {
      console.error("Error loading request details:", error);
      showPopup('Error', 'Failed to load request details');
    })
    .finally(() => {
      hideLoader();
    });
}

// Handle status change to show/hide driver selection
document.getElementById('approvalStatus').addEventListener('change', function() {
  const driverSelection = document.getElementById('driverSelection');
  if (this.value === 'Approved') {
    driverSelection.style.display = 'block';
  } else {
    driverSelection.style.display = 'none';
  }
});

// Submit request approval
function submitRequestApproval() {
  const requestId = document.getElementById('requestId').value;
  const status = document.getElementById('approvalStatus').value;
  const driverId = document.getElementById('assignedDriver').value;
  const remarks = document.getElementById('approvalRemarks').value;
  
  if (!requestId || !status) {
    showPopup('Validation Error', 'Please select a status');
    return;
  }
  
  if (status === 'Approved' && !driverId) {
    showPopup('Validation Error', 'Please select a driver for approved requests');
    return;
  }
  
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) {
    showPopup('Authentication Error', 'Please login again');
    return;
  }
  
  const approvalData = {
    type: 'update-request-status',
    requestId: requestId,
    status: status,
    approvedBy: driverData.name,
    driverId: status === 'Approved' ? driverId : status,
    remarks: remarks
  };
  
  showLoader();
  
  fetch("https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec", {
    method: 'POST',
    body: JSON.stringify(approvalData),
    mode: 'no-cors',
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response => response.text())
  .then(result => {
    console.log("Request update result:", result);
    showPopup('Success', 'Request status updated successfully!');
    loadAllRequests();
    showSection('requests');
  })
  .catch(error => {
    console.error("Error updating request:", error);
    showPopup('Error', 'Failed to update request status');
  })
  .finally(() => {
    hideLoader();
  });
}

// View journey details
function viewJourneyDetails(journeyId) {
  showLoader();
  
  fetch(`https://script.google.com/macros/s/AKfycby6qC6DKPeZfVgNobLn-Qo68YMLI02uUfCO5dMbwOsNDcxBJ8CaIBSORuscUfNsnLsV7w/exec?action=get-journey-details&journeyId=${encodeURIComponent(journeyId)}`)
    .then(response => response.json())
    .then(data => {
      if (data) {
        const detailsContent = document.getElementById('requestDetailsContent');
        detailsContent.innerHTML = `
          <div class="request-details">
            <h3>Journey Details</h3>
            <p><strong>Travel ID:</strong> ${data.TravelID || ''}</p>
            <p><strong>Date:</strong> ${data.Date || ''}</p>
            <p><strong>Driver:</strong> ${data.DriverName || ''} (${data.DriverPhone || ''})</p>
            <p><strong>Vehicle:</strong> ${data.VehicleNumber || ''} (${data.VehicleName || ''})</p>
            <p><strong>Status:</strong> ${getStatusBadge(data.Status || '')}</p>
            
            <h4>Journey Information</h4>
            <p><strong>Start Point:</strong> ${data.StartPoint || ''}</p>
            <p><strong>End Point:</strong> ${data.EndPoint || ''}</p>
            <p><strong>Start KM:</strong> ${data.StartKM || ''}</p>
            <p><strong>End KM:</strong> ${data.EndKM || ''}</p>
            <p><strong>Start Time:</strong> ${formatTime(data.StartTime)}</p>
            <p><strong>End Time:</strong> ${formatTime(data.EndTime)}</p>
            
            <h4>Passenger Information</h4>
            <p><strong>Passenger Count:</strong> ${data.NoPassengers || ''}</p>
            <p><strong>Passenger Name:</strong> ${data.PassengerName || ''}</p>
            <p><strong>Passenger Phone:</strong> ${data.PassengerPhone || ''}</p>
          </div>
        `;
        
        // Hide approval form for journey details
        document.getElementById('approvalForm').style.display = 'none';
        
        showSection('requestDetails');
      } else {
        showPopup('Error', 'Journey details not found');
      }
    })
    .catch(error => {
      console.error("Error loading journey details:", error);
      showPopup('Error', 'Failed to load journey details');
    })
    .finally(() => {
      hideLoader();
    });
}

// Helper function to create status badge
function getStatusBadge(status) {
  const statusClass = status.toLowerCase();
  return `<span class="status-badge status-${statusClass}">${status}</span>`;
}

// Helper function to format time
function formatTime(timeString) {
  if (!timeString) return '';
  
  // If already in HH:MM format
  if (timeString.includes(':')) return timeString;
  
  // If in ISO format
  if (timeString.includes('T')) {
    try {
      const date = new Date(timeString);
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch (e) {
      return timeString;
    }
  }
  
  return timeString;
}

// Load profile data
function loadProfileData() {
  const driverData = JSON.parse(localStorage.getItem('driverData'));
  if (!driverData) return;

  document.getElementById('profileAdminId').textContent = driverData.id || '';
  document.getElementById('profileAdminName').textContent = driverData.name || '';
  document.getElementById('profileUsername').textContent = driverData.username || '';
  document.getElementById('profilePhone').textContent = driverData.phoneNumber || '';
}

// Logout function
function logout() {
  localStorage.removeItem('driverData');
  window.location.href = "index.html";
}

// Loader functions
window.showLoader = function() {
  document.getElementById('loader').style.display = 'flex';
};

window.hideLoader = function() {
  document.getElementById('loader').style.display = 'none';
};

// Show popup function
function showPopup(title, message) {
  const popup = document.getElementById('customPopup');
  const popupTitle = document.getElementById('popupTitle');
  const popupMessage = document.getElementById('popupMessage');
  
  popupTitle.textContent = title;
  popupMessage.textContent = message;
  popup.classList.add('active');
  
  const closePopup = () => {
    popup.classList.remove('active');
    document.getElementById('popupOk').removeEventListener('click', closePopup);
    document.getElementById('popupClose').removeEventListener('click', closePopup);
    popup.removeEventListener('click', outsideClick);
  };
  
  const outsideClick = (e) => {
    if (e.target === popup && !e.target.closest('.popup-container')) {
      closePopup();
    }
  };
  
  document.getElementById('popupOk').addEventListener('click', closePopup);
  document.getElementById('popupClose').addEventListener('click', closePopup);
  popup.addEventListener('click', outsideClick);
}
</script>

<!-- Custom Popup Structure -->
<div class="popup-overlay" id="customPopup">
  <div class="popup-container">
    <button class="popup-close" id="popupClose">&times;</button>
    <h3 class="popup-title" id="popupTitle">Message</h3>
    <div class="popup-message" id="popupMessage"></div>
    <div class="popup-buttons">
      <button class="popup-button" id="popupOk">OK</button>
    </div>
  </div>
</div>

<footer class="app-footer">
  <p>© 2025 Travel Log App | Developed by <strong>R Sukrudha Ram</strong></p>
</footer>
</body>
</html>
